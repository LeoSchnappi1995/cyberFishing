<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberFishing - é’“é±¼æ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Consolas', monospace, Arial, sans-serif;
            background: #0a0e27;
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
            position: relative;
            overflow-x: hidden;
        }

        /* åŠ¨æ€èƒŒæ™¯ - æ°´æ³¢æ•ˆæœ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.3) 0%, transparent 50%),
                linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0f1629 100%);
            z-index: -2;
            animation: wave 20s ease-in-out infinite;
        }

        @keyframes wave {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-20px) scale(1.05); }
        }

        /* æ°”æ³¡æ•ˆæœ */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(102, 126, 234, 0.1) 0%, transparent 2%),
                radial-gradient(circle at 30% 60%, rgba(118, 75, 162, 0.1) 0%, transparent 2%),
                radial-gradient(circle at 70% 40%, rgba(102, 126, 234, 0.1) 0%, transparent 2%),
                radial-gradient(circle at 90% 80%, rgba(118, 75, 162, 0.1) 0%, transparent 2%);
            z-index: -1;
            animation: bubble 15s ease-in-out infinite;
        }

        @keyframes bubble {
            0%, 100% { opacity: 0.5; transform: translateY(0); }
            50% { opacity: 0.8; transform: translateY(-30px); }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(20, 25, 45, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(102, 126, 234, 0.3);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 40px rgba(102, 126, 234, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            border-bottom: 2px solid rgba(102, 126, 234, 0.5);
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(102, 126, 234, 0.8), 0 0 40px rgba(118, 75, 162, 0.5);
            letter-spacing: 2px;
        }

        .header-actions {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .game-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .info-item {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
            transition: all 0.3s;
        }

        .info-item:hover {
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3), inset 0 1px 0 rgba(255,255,255,0.1);
            transform: translateY(-2px);
        }

        .info-item label {
            display: block;
            font-size: 0.9em;
            color: #a0a0a0;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-item .value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            text-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
            font-family: 'Consolas', monospace;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        .panel {
            background: rgba(30, 35, 55, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1);
            transition: all 0.3s;
        }

        .panel:hover {
            border-color: rgba(102, 126, 234, 0.4);
            box-shadow: 0 8px 40px rgba(102, 126, 234, 0.2), inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.3);
            text-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
            font-size: 1.3em;
            letter-spacing: 1px;
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .button:active {
            transform: translateY(0);
        }

        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .button.danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .button.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        select, input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            margin: 5px 0;
        }

        .fish-list, .bait-list, .boat-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .fish-item, .bait-item, .boat-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .fish-item h3 {
            color: #667eea;
            margin-bottom: 5px;
        }

        .fish-item .info {
            font-size: 0.9em;
            color: #666;
        }

        .message {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .achievements {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .achievement {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .achievement.locked {
            background: #ccc;
            opacity: 0.5;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-content h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .settlement-item {
            padding: 10px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 8px;
        }

        /* é’“é±¼åœºæ™¯æ ·å¼ */
        .fishing-scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            overflow: hidden;
        }

        .scene-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            transition: opacity 0.5s;
        }

        /* ä¸åŒæ°´åŸŸçš„èƒŒæ™¯ */
        .scene-background.stream {
            background: linear-gradient(180deg, #87CEEB 0%, #4A90E2 50%, #2E5C8A 100%);
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(255,255,255,0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 60%, rgba(255,255,255,0.2) 0%, transparent 50%);
        }

        .scene-background.river {
            background: linear-gradient(180deg, #4682B4 0%, #1E3A5F 50%, #0F1F35 100%);
            background-image: 
                radial-gradient(circle at 30% 40%, rgba(135,206,250,0.3) 0%, transparent 50%),
                radial-gradient(circle at 70% 70%, rgba(135,206,250,0.2) 0%, transparent 50%);
        }

        .scene-background.lake {
            background: linear-gradient(180deg, #5F9EA0 0%, #2F4F4F 50%, #1A2F2F 100%);
            background-image: 
                radial-gradient(circle at 25% 35%, rgba(95,158,160,0.4) 0%, transparent 50%),
                radial-gradient(circle at 75% 65%, rgba(95,158,160,0.3) 0%, transparent 50%);
        }

        .scene-background.bay {
            background: linear-gradient(180deg, #4169E1 0%, #000080 50%, #000033 100%);
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(65,105,225,0.4) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(65,105,225,0.3) 0%, transparent 50%);
        }

        .scene-background.deep_sea {
            background: linear-gradient(180deg, #000033 0%, #000022 50%, #000011 100%);
            background-image: 
                radial-gradient(circle at 30% 40%, rgba(102,126,234,0.2) 0%, transparent 50%),
                radial-gradient(circle at 70% 60%, rgba(118,75,162,0.2) 0%, transparent 50%);
            animation: deepSeaGlow 3s ease-in-out infinite;
        }

        @keyframes deepSeaGlow {
            0%, 100% { filter: brightness(0.8); }
            50% { filter: brightness(1.2); }
        }

        .scene-header {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 10px;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .scene-info {
            display: flex;
            gap: 20px;
            color: white;
            font-size: 1.1em;
        }

        .scene-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .scene-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .fishing-area {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }

        .water-surface {
            position: relative;
            width: 100%;
            height: 70%;
            overflow: hidden;
        }

        /* æ°´é¢æ³¢çº¹åŠ¨ç”» */
        .water-surface::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 200%;
            height: 100%;
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 2px,
                rgba(255,255,255,0.1) 2px,
                rgba(255,255,255,0.1) 4px
            );
            animation: wave 3s linear infinite;
        }

        @keyframes wave {
            0% { left: -100%; }
            100% { left: 0%; }
        }

        /* æµ®æ¼‚ */
        .float {
            position: absolute;
            left: 50%;
            top: 30%;
            transform: translateX(-50%);
            transition: all 0.3s;
        }

        .float-body {
            width: 20px;
            height: 30px;
            background: linear-gradient(180deg, #FFD700 0%, #FFA500 100%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.5);
            animation: floatBobbing 2s ease-in-out infinite;
        }

        @keyframes floatBobbing {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-5px) rotate(-2deg); }
            75% { transform: translateY(5px) rotate(2deg); }
        }

        .float-line {
            width: 2px;
            height: 200px;
            background: linear-gradient(180deg, transparent 0%, rgba(200,200,200,0.5) 100%);
            margin: 0 auto;
            position: relative;
        }

        .float-line::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: #888;
            border-radius: 50%;
        }

        /* æµ®æ¼‚å’¬é’©åŠ¨ç”» */
        .float.biting {
            animation: floatBiting 0.5s ease-in-out infinite;
        }

        @keyframes floatBiting {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-15px); }
        }

        .float.strong-bite {
            animation: floatStrongBite 0.3s ease-in-out infinite;
        }

        @keyframes floatStrongBite {
            0%, 100% { transform: translateX(-50%) translateY(0) scale(1); }
            50% { transform: translateX(-50%) translateY(-20px) scale(1.1); }
        }

        .fishing-hint {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            padding: 20px 40px;
            border-radius: 15px;
            border: 2px solid rgba(102, 126, 234, 0.5);
            color: white;
            text-align: center;
            font-size: 1.2em;
            z-index: 10;
        }

        .fishing-controls {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            z-index: 10;
        }

        .fishing-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.2em;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
        }

        .fishing-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .fishing-btn:active {
            transform: translateY(0);
        }

        /* æ—¶æœºæŒ‡ç¤ºå™¨ */
        .timing-indicator {
            position: absolute;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            z-index: 10;
        }

        .timing-bar {
            position: relative;
            height: 30px;
            background: rgba(0,0,0,0.5);
            border-radius: 15px;
            border: 2px solid rgba(102, 126, 234, 0.5);
            overflow: hidden;
        }

        .timing-zone {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, #4facfe 50%, transparent 100%);
            width: 30%;
            left: 35%;
            animation: timingZonePulse 1s ease-in-out infinite;
        }

        @keyframes timingZonePulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .timing-marker {
            position: absolute;
            width: 4px;
            height: 100%;
            background: #fff;
            left: 0;
            animation: timingMarkerMove 3s linear infinite;
            box-shadow: 0 0 10px rgba(255,255,255,0.8);
        }

        @keyframes timingMarkerMove {
            0% { left: 0; }
            100% { left: calc(100% - 4px); }
        }

        .timing-hint {
            text-align: center;
            color: white;
            margin-top: 10px;
            font-size: 0.9em;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
        }

        /* ç”©æ†åŠ¨ç”» */
        .casting {
            animation: castRod 1s ease-out;
        }

        @keyframes castRod {
            0% { transform: translateX(-50%) translateY(0) rotate(0deg); }
            50% { transform: translateX(-50%) translateY(-100px) rotate(45deg); }
            100% { transform: translateX(-50%) translateY(0) rotate(0deg); }
        }

        /* ç»“æœå±•ç¤º */
        .fishing-result {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }

        .result-content {
            background: rgba(30, 35, 55, 0.95);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 20px;
            border: 2px solid rgba(102, 126, 234, 0.5);
            text-align: center;
            color: white;
            font-size: 1.5em;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .result-content.success {
            border-color: #4facfe;
            box-shadow: 0 10px 40px rgba(79, 172, 254, 0.3);
        }

        .result-content.failure {
            border-color: #f5576c;
            box-shadow: 0 10px 40px rgba(245, 87, 108, 0.3);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .fishing-hint {
                font-size: 1em;
                padding: 15px 20px;
            }
            
            .fishing-btn {
                padding: 12px 30px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-actions">
                <button class="header-btn" onclick="openSettings()">âš™ï¸ è®¾ç½®</button>
                <button class="header-btn" onclick="openMap()">ğŸ—ºï¸ åœ°å›¾</button>
                <button class="header-btn" onclick="openEncyclopedia()">ğŸ“š å›¾é‰´</button>
                <button class="header-btn" onclick="openAchievements()">ğŸ† æˆå°±</button>
                <button class="header-btn" onclick="openHelp()">â“ å¸®åŠ©</button>
            </div>
            <div class="header-content">
                <h1>ğŸ£ CyberFishing</h1>
                <p>å›åˆåˆ¶ç­–ç•¥é’“é±¼æ¸¸æˆ</p>
            </div>
        </div>

        <div class="game-info">
            <div class="info-item">
                <label>ğŸ’° é‡‘é’±</label>
                <div class="value" id="money">500</div>
            </div>
            <div class="info-item">
                <label>ğŸš¤ èˆ¹åª</label>
                <div class="value" id="boat">æ— èˆ¹</div>
            </div>
            <div class="info-item">
                <label>ğŸ£ å·²é’“é±¼ç§</label>
                <div class="value" id="caughtCount">0</div>
            </div>
            <div class="info-item">
                <label>ğŸ† ç§°å·</label>
                <div class="value" id="achievementCount">1</div>
            </div>
        </div>

        <div class="main-content">
            <!-- å·¦ä¾§ï¼šé’“é±¼åŒºåŸŸ -->
            <div class="panel">
                <h2>ğŸ£ é’“é±¼</h2>
                <div id="fishingArea">
                    <label>é€‰æ‹©æ°´åŸŸï¼š</label>
                    <select id="environmentSelect">
                        <option value="stream">æºªæµ</option>
                        <option value="river">æ±Ÿè¾¹</option>
                    </select>

                    <label>ç›®æ ‡é±¼ç±»ï¼š</label>
                    <select id="fishSelect"></select>

                    <label>é€‰æ‹©é±¼é¥µï¼š</label>
                    <select id="baitSelect"></select>

                    <label>
                        <input type="checkbox" id="useConsumable"> ä½¿ç”¨å¹¸è¿ç¬¦ (+10%)
                    </label>

                    <div id="riskWarning"></div>

                    <button class="button" onclick="checkRisk()">æ£€æŸ¥é£é™©</button>
                    <button class="button success" onclick="startFishingScene()">å¼€å§‹é’“é±¼</button>
                    <button class="button danger" onclick="endGame()" style="margin-top: 10px;">ç»“æŸæ¸¸æˆå¹¶ç»“ç®—</button>
                </div>
            </div>

            <!-- å³ä¾§ï¼šå•†åº—å’Œåº“å­˜ -->
            <div class="panel">
                <h2>ğŸª å•†åº—</h2>
                <div id="shopArea">
                    <h3>è´­ä¹°èˆ¹åª</h3>
                    <div id="boatShop"></div>

                    <h3>è´­ä¹°é±¼é¥µ</h3>
                    <div id="baitShop"></div>

                    <h3>è´­ä¹°æ¶ˆè€—å“</h3>
                    <div id="consumableShop"></div>
                </div>

                <h2 style="margin-top: 20px;">ğŸ“¦ åº“å­˜</h2>
                <div id="inventoryArea">
                    <h3>é±¼é¥µåº“å­˜</h3>
                    <div id="baitInventory"></div>

                    <h3>æ´»é±¼åº“å­˜ï¼ˆå¯ç”¨ä½œé±¼é¥µï¼‰</h3>
                    <div id="liveFishInventory"></div>
                </div>
            </div>
        </div>

        <!-- æˆå°±åŒºåŸŸ -->
        <div class="panel" style="margin: 20px;">
            <h2>ğŸ† æˆå°±ä¸ç§°å·</h2>
            <div id="achievementsArea" class="achievements"></div>
        </div>

        <!-- æ¶ˆæ¯åŒºåŸŸ -->
        <div id="messageArea" style="padding: 20px;"></div>

        <!-- ç»“ç®—æ¨¡æ€æ¡† -->
        <div class="modal" id="settlementModal">
            <div class="modal-content">
                <h2>æ¸¸æˆç»“ç®—</h2>
                <div id="settlementContent"></div>
                <button class="button" onclick="closeSettlement()">å…³é—­</button>
                <button class="button success" onclick="resetGame()">é‡æ–°å¼€å§‹</button>
            </div>
        </div>

        <!-- åœ°å›¾å¯è§†åŒ–æ¨¡æ€æ¡† -->
        <div class="modal" id="mapModal">
            <div class="modal-content" style="max-width: 800px;">
                <h2>ğŸ—ºï¸ æ°´åŸŸåœ°å›¾</h2>
                <div id="mapContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                </div>
                <button class="button" onclick="closeMap()">å…³é—­</button>
            </div>
        </div>

        <!-- è®¾ç½®é¢æ¿æ¨¡æ€æ¡† -->
        <div class="modal" id="settingsModal">
            <div class="modal-content">
                <h2>âš™ï¸ è®¾ç½®</h2>
                <div style="margin: 20px 0;">
                    <label style="display: flex; align-items: center; gap: 10px; margin: 15px 0;">
                        <input type="checkbox" id="soundEnabled" checked onchange="toggleSound()">
                        <span>å¯ç”¨éŸ³æ•ˆ</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; margin: 15px 0;">
                        <input type="checkbox" id="musicEnabled" checked onchange="toggleMusic()">
                        <span>å¯ç”¨èƒŒæ™¯éŸ³ä¹</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; margin: 15px 0;">
                        <input type="range" id="volumeSlider" min="0" max="100" value="50" onchange="setVolume(this.value)">
                        <span>éŸ³é‡: <span id="volumeValue">50</span>%</span>
                    </label>
                </div>
                <button class="button" onclick="closeSettings()">å…³é—­</button>
            </div>
        </div>

        <!-- å›¾é‰´ç³»ç»Ÿæ¨¡æ€æ¡† -->
        <div class="modal" id="encyclopediaModal">
            <div class="modal-content" style="max-width: 900px;">
                <h2>ğŸ“š é±¼ç±»å›¾é‰´</h2>
                <div id="encyclopediaContent" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin: 20px 0; max-height: 70vh; overflow-y: auto;">
                </div>
                <button class="button" onclick="closeEncyclopedia()">å…³é—­</button>
            </div>
        </div>

        <!-- æˆå°±å¢™æ¨¡æ€æ¡† -->
        <div class="modal" id="achievementsModal">
            <div class="modal-content" style="max-width: 800px;">
                <h2>ğŸ† æˆå°±å¢™</h2>
                <div id="achievementsWall" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                </div>
                <button class="button" onclick="closeAchievements()">å…³é—­</button>
            </div>
        </div>

        <!-- å¸®åŠ©ç³»ç»Ÿæ¨¡æ€æ¡† -->
        <div class="modal" id="helpModal">
            <div class="modal-content" style="max-width: 700px;">
                <h2>â“ æ¸¸æˆå¸®åŠ©</h2>
                <div style="margin: 20px 0; line-height: 1.8;">
                    <h3>æ¸¸æˆç›®æ ‡</h3>
                    <p>é€šè¿‡é’“é±¼ã€ç®¡ç†èµ„æºã€å‡çº§èˆ¹åªï¼Œé€æ­¥æ¢ç´¢æ›´å±é™©çš„æ°´åŸŸï¼Œå°½å¯èƒ½èµ°å¾—æ›´è¿œã€‚</p>
                    
                    <h3>åŸºæœ¬æ“ä½œ</h3>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>é€‰æ‹©æ°´åŸŸ â†’ é€‰æ‹©ç›®æ ‡é±¼ç±» â†’ é€‰æ‹©é±¼é¥µ â†’ å¼€å§‹é’“é±¼</li>
                        <li>åœ¨å•†åº—è´­ä¹°èˆ¹åªã€é±¼é¥µå’Œæ¶ˆè€—å“</li>
                        <li>ä½¿ç”¨æ´»é±¼ä½œä¸ºé±¼é¥µï¼ˆéœ€è¦å…ˆé’“åˆ°ï¼‰</li>
                    </ul>
                    
                    <h3>æˆåŠŸç‡è®¡ç®—</h3>
                    <p>åŸºç¡€60% - (éš¾åº¦-1)Ã—15% + é±¼é¥µåŠ æˆ(æ´»é±¼+20%) + æ¶ˆè€—å“åŠ æˆ(å¹¸è¿ç¬¦+10%)</p>
                    
                    <h3>ç¿»èˆ¹é£é™©</h3>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>æµ·æ¹¾ï¼šä¸­èˆ¹ + éš¾åº¦5+ + æˆåŠŸç‡<40% = ç¿»èˆ¹ï¼ˆä¸¢å¤±æ‰€æœ‰é±¼é¥µå’Œé±¼ï¼‰</li>
                        <li>æ·±æµ·ï¼šéå¤§èˆ¹ = ç«‹å³å¤±è´¥ï¼Œå¤§èˆ¹ = 5%å¤±è´¥é£é™©</li>
                    </ul>
                    
                    <h3>æ·±æµ·é˜¶æ®µ</h3>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>æ¢ç´¢ï¼šé¦–æ¬¡è¿›å…¥æ·±æµ·</li>
                        <li>å®Œæˆï¼šé’“åˆ°å¤§ç‹ä¹Œè´¼</li>
                        <li>ç»ˆæï¼šé’“åˆ°å…‹è‹é²</li>
                    </ul>
                </div>
                <button class="button" onclick="closeHelp()">å…³é—­</button>
            </div>
        </div>

        <!-- é£é™©è­¦å‘Šå¼¹çª— -->
        <div class="modal" id="riskModal">
            <div class="modal-content" style="max-width: 500px; border: 2px solid #f5576c;">
                <h2 style="color: #f5576c;">âš ï¸ é£é™©è­¦å‘Š</h2>
                <div id="riskModalContent" style="margin: 20px 0; font-size: 1.1em; line-height: 1.8;"></div>
                <div style="display: flex; gap: 10px;">
                    <button class="button danger" onclick="confirmRisk()">ç¡®è®¤ç»§ç»­</button>
                    <button class="button" onclick="cancelRisk()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—ç³»ç»Ÿ -->
        <div class="panel" style="margin: 20px; max-height: 200px; overflow-y: auto;">
            <h2>ğŸ“œ æ¸¸æˆæ—¥å¿—</h2>
            <div id="gameLog" style="font-size: 0.9em; color: #a0a0a0;"></div>
        </div>

        <!-- æ·±æµ·é˜¶æ®µè¿›åº¦æ¡ -->
        <div class="panel" style="margin: 20px;" id="deepSeaProgressPanel" style="display: none;">
            <h2>ğŸŒŠ æ·±æµ·æ¢ç´¢è¿›åº¦</h2>
            <div style="margin: 15px 0;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>é˜¶æ®µ: <span id="deepSeaStageText">æœªå¼€å§‹</span></span>
                    <span id="deepSeaProgressText">0%</span>
                </div>
                <div style="background: rgba(0,0,0,0.3); border-radius: 10px; height: 20px; overflow: hidden; border: 1px solid rgba(102, 126, 234, 0.3);">
                    <div id="deepSeaProgressBar" style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 0%; transition: width 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8em;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- é’“é±¼åœºæ™¯é¡µé¢ -->
    <div id="fishingScene" class="fishing-scene" style="display: none;">
        <div class="scene-background" id="sceneBackground"></div>
        
        <!-- åœºæ™¯ä¿¡æ¯æ  -->
        <div class="scene-header">
            <div class="scene-info">
                <span id="sceneEnvironmentName">æºªæµ</span>
                <span id="sceneTargetFish">ç›®æ ‡ï¼šå°é±¼</span>
            </div>
            <button class="scene-btn" onclick="exitFishingScene()">è¿”å›</button>
        </div>

        <!-- é’“é±¼åŒºåŸŸ -->
        <div class="fishing-area">
            <!-- æ°´é¢ -->
            <div class="water-surface" id="waterSurface">
                <!-- æµ®æ¼‚ -->
                <div class="float" id="float">
                    <div class="float-body"></div>
                    <div class="float-line"></div>
                </div>
            </div>

            <!-- æ“ä½œæç¤º -->
            <div class="fishing-hint" id="fishingHint">
                <div id="fishingStatus">å‡†å¤‡ç”©æ†...</div>
                <div id="fishingTimer" style="font-size: 0.9em; margin-top: 10px; opacity: 0.8;"></div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="fishing-controls">
                <button class="fishing-btn" id="castBtn" onclick="castFishingRod()">ç”©æ†</button>
                <button class="fishing-btn" id="reelBtn" onclick="reelIn()" style="display: none;">æ”¶çº¿</button>
            </div>

            <!-- æ—¶æœºæŒ‡ç¤ºå™¨ -->
            <div class="timing-indicator" id="timingIndicator" style="display: none;">
                <div class="timing-bar">
                    <div class="timing-zone" id="timingZone"></div>
                    <div class="timing-marker" id="timingMarker"></div>
                </div>
                <div class="timing-hint">ç­‰å¾…æœ€ä½³æ”¶çº¿æ—¶æœº...</div>
            </div>
        </div>

        <!-- ç»“æœå±•ç¤º -->
        <div class="fishing-result" id="fishingResult" style="display: none;">
            <div class="result-content" id="resultContent"></div>
            <button class="fishing-btn" onclick="continueFishing()">ç»§ç»­é’“é±¼</button>
            <button class="fishing-btn" onclick="exitFishingScene()">è¿”å›</button>
        </div>
    </div>

    <script>
        // ========== æ¸¸æˆé…ç½® ==========
        const FISH_CONFIG = {
            small_fish: { id: 'small_fish', name: 'å°é±¼', environment: 'stream', difficulty: 1, type: 'herbivore', requiredBaitType: 'plant', weightRange: { min: 0.1, max: 0.5 }, basePrice: 10, canBeBait: true },
            stream_fish: { id: 'stream_fish', name: 'æºªé±¼', environment: 'stream', difficulty: 2, type: 'herbivore', requiredBaitType: 'plant', weightRange: { min: 0.3, max: 0.8 }, basePrice: 25, canBeBait: true },
            catfish: { id: 'catfish', name: 'é²¶é±¼', environment: 'stream', difficulty: 3, type: 'carnivore', requiredBaitType: 'live_fish', weightRange: { min: 0.5, max: 2.0 }, basePrice: 50, canBeBait: true },
            river_carp: { id: 'river_carp', name: 'æ±Ÿé²¤', environment: 'river', difficulty: 2, type: 'herbivore', requiredBaitType: 'plant', weightRange: { min: 0.5, max: 1.5 }, basePrice: 30, canBeBait: true },
            river_pike: { id: 'river_pike', name: 'æ±Ÿé²ˆ', environment: 'river', difficulty: 3, type: 'carnivore', requiredBaitType: 'live_fish', weightRange: { min: 1.0, max: 3.0 }, basePrice: 60, canBeBait: true },
            lake_trout: { id: 'lake_trout', name: 'æ¹–é³Ÿ', environment: 'lake', difficulty: 3, type: 'carnivore', requiredBaitType: 'live_fish', weightRange: { min: 1.5, max: 4.0 }, basePrice: 80, canBeBait: true },
            lake_bass: { id: 'lake_bass', name: 'æ¹–é²ˆ', environment: 'lake', difficulty: 4, type: 'carnivore', requiredBaitType: 'live_fish', weightRange: { min: 2.0, max: 5.0 }, basePrice: 120, canBeBait: true },
            bay_tuna: { id: 'bay_tuna', name: 'æµ·æ¹¾é‡‘æªé±¼', environment: 'bay', difficulty: 4, type: 'carnivore', requiredBaitType: 'live_fish', weightRange: { min: 5.0, max: 15.0 }, basePrice: 200, canBeBait: true },
            bay_shark: { id: 'bay_shark', name: 'å¤§ç™½é²¨', environment: 'bay', difficulty: 5, type: 'deep_predator', requiredBaitType: 'live_fish', weightRange: { min: 50.0, max: 200.0 }, basePrice: 500, canBeBait: true },
            giant_squid: { id: 'giant_squid', name: 'å¤§ç‹ä¹Œè´¼', environment: 'deep_sea', difficulty: 5, type: 'deep_predator', requiredBaitType: 'live_fish', requiredSpecificBait: ['bay_shark', 'bay_tuna'], weightRange: { min: 100.0, max: 300.0 }, basePrice: 1000, canBeBait: true },
            sperm_whale: { id: 'sperm_whale', name: 'æŠ¹é¦™é²¸', environment: 'deep_sea', difficulty: 5, type: 'deep_predator', requiredBaitType: 'live_fish', requiredSpecificBait: ['giant_squid'], weightRange: { min: 500.0, max: 2000.0 }, basePrice: 2000, canBeBait: true },
            cthulhu: { id: 'cthulhu', name: 'å…‹è‹é²', environment: 'deep_sea', difficulty: 6, type: 'deep_predator', requiredBaitType: 'live_fish', requiredSpecificBait: ['sperm_whale'], weightRange: { min: 1000.0, max: 5000.0 }, basePrice: 5000, canBeBait: false }
        };

        const BOAT_CONFIG = {
            none: { id: 'none', name: 'æ— èˆ¹', price: 0, accessibleEnvironments: ['stream', 'river'] },
            small: { id: 'small', name: 'å°èˆ¹', price: 300, accessibleEnvironments: ['stream', 'river', 'lake'] },
            medium: { id: 'medium', name: 'ä¸­èˆ¹', price: 600, accessibleEnvironments: ['stream', 'river', 'lake', 'bay'] },
            large: { id: 'large', name: 'å¤§èˆ¹', price: 1200, accessibleEnvironments: ['stream', 'river', 'lake', 'bay', 'deep_sea'] }
        };

        const ENVIRONMENT_CONFIG = {
            stream: { id: 'stream', name: 'æºªæµ', unlockCondition: 'default', hasCapsizeRisk: false },
            river: { id: 'river', name: 'æ±Ÿè¾¹', unlockCondition: 'default', hasCapsizeRisk: false },
            lake: { id: 'lake', name: 'æ¹–æ³Š', unlockCondition: 'small_boat', hasCapsizeRisk: false },
            bay: { id: 'bay', name: 'æµ·æ¹¾', unlockCondition: 'medium_boat', hasCapsizeRisk: true },
            deep_sea: { id: 'deep_sea', name: 'æ·±æµ·', unlockCondition: 'large_boat', hasCapsizeRisk: true }
        };

        const ACHIEVEMENT_CONFIG = {
            beginner_angler: { id: 'beginner_angler', name: 'åˆå¿ƒé’“æ‰‹' },
            bay_adventurer: { id: 'bay_adventurer', name: 'æµ·æ¹¾å†’é™©è€…' },
            deep_sea_explorer: { id: 'deep_sea_explorer', name: 'æ·±æµ·æ¢è·¯è€…' },
            deep_sea_conqueror: { id: 'deep_sea_conqueror', name: 'æ·±æµ·å¾æœè€…' },
            deep_sea_hunter: { id: 'deep_sea_hunter', name: 'æ·±æµ·çŒäºº' },
            forbidden_touch: { id: 'forbidden_touch', name: 'ç¦å¿Œä¹‹è§¦' }
        };

        const BAIT_CONFIG = {
            plant: { id: 'plant', name: 'æ¤ç‰©æ€§é¥µæ–™', price: 5 },
            dead_fish: { id: 'dead_fish', name: 'é±¼å—ï¼ˆæ­»é±¼ï¼‰', price: 15 }
        };

        const CONSUMABLE_CONFIG = {
            lucky_charm: { id: 'lucky_charm', name: 'å¹¸è¿ç¬¦', price: 50 }
        };

        // ========== æ¸¸æˆçŠ¶æ€ ==========
        let gameState = {
            money: 500,
            boat: 'none',
            baitInventory: { plant: 0, dead_fish: 0 },
            liveFishInventory: {},
            caughtFish: {},
            achievements: ['beginner_angler'],
            gameStartTime: Date.now(),
            lastUpdateTime: Date.now(),
            gameTime: 0,
            deathCount: 0,
            deepSeaStage: 'none',
            gameOver: false,
            consumables: {}
        };

        // ========== æ•°æ®æŒä¹…åŒ– ==========
        function saveGameState() {
            gameState.lastUpdateTime = Date.now();
            const timeDiff = Math.floor((Date.now() - gameState.gameStartTime) / 1000);
            gameState.gameTime = timeDiff;
            localStorage.setItem('cyberFishing_gameState', JSON.stringify(gameState));
        }

        function loadGameState() {
            const saved = localStorage.getItem('cyberFishing_gameState');
            if (saved) {
                gameState = JSON.parse(saved);
                // æ›´æ–°æ¸¸æˆæ—¶é—´
                const timeDiff = Math.floor((Date.now() - gameState.lastUpdateTime) / 1000);
                gameState.gameTime += timeDiff;
                gameState.lastUpdateTime = Date.now();
            }
        }

        function resetGameState() {
            gameState = {
                money: 500,
                boat: 'none',
                baitInventory: { plant: 0, dead_fish: 0 },
                liveFishInventory: {},
                caughtFish: {},
                achievements: ['beginner_angler'],
                gameStartTime: Date.now(),
                lastUpdateTime: Date.now(),
                gameTime: 0,
                deathCount: 0,
                deepSeaStage: 'none',
                gameOver: false,
                consumables: {}
            };
            saveGameState();
            updateUI();
        }

        // ========== å·¥å…·å‡½æ•° ==========
        function canBoatAccessEnvironment(boatId, environmentId) {
            const boat = BOAT_CONFIG[boatId];
            return boat && boat.accessibleEnvironments.includes(environmentId);
        }

        function getFishByEnvironment(environmentId) {
            return Object.values(FISH_CONFIG).filter(fish => fish.environment === environmentId);
        }

        function calculateSuccessRate(fish, baitId, useConsumable) {
            let successRate = 60;
            const rodLevel = 1;
            const adjustment = (fish.difficulty - rodLevel) * 15;
            successRate -= adjustment;
            
            if (baitId !== 'plant' && baitId !== 'dead_fish') {
                successRate += 20; // æ´»é±¼ +20%
            }
            
            if (useConsumable) {
                successRate += 10; // å¹¸è¿ç¬¦ +10%
            }
            
            return Math.max(0, Math.min(100, successRate));
        }

        function checkCapsizeRisk(environmentId, boatId, fish, successRate) {
            if (environmentId === 'bay') {
                if (boatId === 'medium' && fish.difficulty >= 5 && successRate < 40) {
                    return { risk: true, shouldCapsize: true, message: 'é«˜é£é™©ï¼šä¸­èˆ¹ + éš¾åº¦5+ + æˆåŠŸç‡<40%ï¼Œå¯èƒ½ç¿»èˆ¹' };
                }
            }
            if (environmentId === 'deep_sea') {
                if (boatId !== 'large') {
                    return { risk: true, shouldCapsize: true, message: 'æ— æ³•è¿›å…¥æ·±æµ·ï¼Œéœ€è¦å¤§èˆ¹' };
                }
                return { risk: true, shouldCapsize: false, message: 'æ·±æµ·é’“é±¼ï¼šå¤§èˆ¹æœ‰5%å¤±è´¥é£é™©ï¼ˆæ¸¸æˆç»“æŸï¼‰' };
            }
            return { risk: false };
        }

        // ========== æ¸¸æˆé€»è¾‘ ==========
        function checkRisk() {
            const environmentId = document.getElementById('environmentSelect').value;
            const fishId = document.getElementById('fishSelect').value;
            const baitId = document.getElementById('baitSelect').value;
            const useConsumable = document.getElementById('useConsumable').checked;

            if (!fishId || !baitId) {
                showMessage('è¯·é€‰æ‹©ç›®æ ‡é±¼ç±»å’Œé±¼é¥µ', 'error');
                return;
            }

            const fish = FISH_CONFIG[fishId];
            const successRate = calculateSuccessRate(fish, baitId, useConsumable);
            const capsizeInfo = checkCapsizeRisk(environmentId, gameState.boat, fish, successRate);

            let warning = `<div class="message info">æˆåŠŸç‡: ${successRate.toFixed(1)}%</div>`;
            if (capsizeInfo.risk) {
                warning += `<div class="message warning">âš ï¸ ${capsizeInfo.message}</div>`;
            }
            if (environmentId === 'deep_sea') {
                if (gameState.boat !== 'large') {
                    warning += `<div class="message error">âŒ æ— æ³•è¿›å…¥æ·±æµ·ï¼Œéœ€è¦å¤§èˆ¹ã€‚æ¸¸æˆå°†ç»“æŸã€‚</div>`;
                } else {
                    warning += `<div class="message warning">âš ï¸ æ·±æµ·é’“é±¼ï¼šå¤§èˆ¹æœ‰5%å¤±è´¥é£é™©ï¼ˆæ¸¸æˆç»“æŸï¼‰</div>`;
                }
            }

            document.getElementById('riskWarning').innerHTML = warning;
        }

        function attemptFishing() {
            if (gameState.gameOver) {
                showMessage('æ¸¸æˆå·²ç»“æŸ', 'error');
                return;
            }

            const environmentId = document.getElementById('environmentSelect').value;
            const fishId = document.getElementById('fishSelect').value;
            const baitId = document.getElementById('baitSelect').value;
            const useConsumable = document.getElementById('useConsumable').checked;

            if (!fishId || !baitId) {
                showMessage('è¯·é€‰æ‹©ç›®æ ‡é±¼ç±»å’Œé±¼é¥µ', 'error');
                return;
            }

            // æ£€æŸ¥èˆ¹åªè®¿é—®æƒé™
            if (!canBoatAccessEnvironment(gameState.boat, environmentId)) {
                showMessage('å½“å‰èˆ¹åªæ— æ³•è¿›å…¥æ­¤æ°´åŸŸ', 'error');
                return;
            }

            const fish = FISH_CONFIG[fishId];
            if (!fish || fish.environment !== environmentId) {
                showMessage('æ— æ•ˆçš„é±¼ç±»é€‰æ‹©', 'error');
                return;
            }

            // æ£€æŸ¥æˆå°±ï¼ˆè¿›å…¥æ–°ç¯å¢ƒï¼‰
            if (environmentId === 'bay' && !gameState.achievements.includes('bay_adventurer')) {
                gameState.achievements.push('bay_adventurer');
            }
            if (environmentId === 'deep_sea') {
                if (!gameState.achievements.includes('deep_sea_explorer')) {
                    gameState.achievements.push('deep_sea_explorer');
                }
                if (gameState.deepSeaStage === 'none') {
                    gameState.deepSeaStage = 'exploring';
                }
            }

            // æ·±æµ·è¿›å…¥æ£€æŸ¥
            if (environmentId === 'deep_sea') {
                if (gameState.boat !== 'large') {
                    handleDeepSeaFailure();
                    return;
                }
                if (Math.random() < 0.05) {
                    handleDeepSeaFailure();
                    return;
                }
            }

            // éªŒè¯é±¼é¥µ
            const baitCheck = validateBait(baitId, fish);
            if (!baitCheck.valid) {
                showMessage(baitCheck.error, 'error');
                return;
            }

            // æ£€æŸ¥æ¶ˆè€—å“
            if (useConsumable && (!gameState.consumables?.lucky_charm || gameState.consumables.lucky_charm <= 0)) {
                showMessage('æ²¡æœ‰å¹¸è¿ç¬¦', 'error');
                return;
            }

            // è®¡ç®—æˆåŠŸç‡
            const successRate = calculateSuccessRate(fish, baitId, useConsumable);
            const roll = Math.random() * 100;
            const fishingSuccess = roll < successRate;

            // æ£€æŸ¥ç¿»èˆ¹é£é™©
            const capsizeInfo = checkCapsizeRisk(environmentId, gameState.boat, fish, successRate);
            if (capsizeInfo.risk && !fishingSuccess && capsizeInfo.shouldCapsize) {
                handleCapsize();
                return;
            }

            // æ¶ˆè€—é±¼é¥µ
            consumeBait(baitId);

            // æ¶ˆè€—æ¶ˆè€—å“
            if (useConsumable) {
                gameState.consumables.lucky_charm = (gameState.consumables.lucky_charm || 0) - 1;
            }

            if (fishingSuccess) {
                handleFishingSuccess(fish);
            } else {
                showMessage('é’“é±¼å¤±è´¥ï¼Œæ¶ˆè€—äº†1ä¸ªé±¼é¥µ', 'error');
                saveGameState();
                updateUI();
            }
        }

        function validateBait(baitId, fish) {
            if (fish.requiredBaitType === 'live_fish') {
                if (fish.requiredSpecificBait) {
                    if (!fish.requiredSpecificBait.includes(baitId)) {
                        return { valid: false, error: `æ­¤é±¼éœ€è¦ç‰¹å®šçš„æ´»é±¼é±¼é¥µ: ${fish.requiredSpecificBait.map(id => FISH_CONFIG[id].name).join('æˆ–')}` };
                    }
                }
                if (!gameState.liveFishInventory[baitId] || gameState.liveFishInventory[baitId] <= 0) {
                    return { valid: false, error: 'æ²¡æœ‰å¯ç”¨çš„æ´»é±¼é±¼é¥µ' };
                }
                return { valid: true };
            }

            if (baitId === 'plant') {
                if (fish.type !== 'herbivore') {
                    return { valid: false, error: 'æ¤ç‰©æ€§é¥µæ–™åªèƒ½é’“æ¤é£Ÿæ€§é±¼' };
                }
                if (!gameState.baitInventory.plant || gameState.baitInventory.plant <= 0) {
                    return { valid: false, error: 'æ²¡æœ‰æ¤ç‰©æ€§é¥µæ–™' };
                }
                return { valid: true };
            }

            if (baitId === 'dead_fish') {
                if (!gameState.baitInventory.dead_fish || gameState.baitInventory.dead_fish <= 0) {
                    return { valid: false, error: 'æ²¡æœ‰é±¼å—' };
                }
                return { valid: true };
            }

            return { valid: false, error: 'æ— æ•ˆçš„é±¼é¥µ' };
        }

        function consumeBait(baitId) {
            if (baitId === 'plant') {
                gameState.baitInventory.plant = Math.max(0, gameState.baitInventory.plant - 1);
            } else if (baitId === 'dead_fish') {
                gameState.baitInventory.dead_fish = Math.max(0, gameState.baitInventory.dead_fish - 1);
            } else {
                gameState.liveFishInventory[baitId] = Math.max(0, (gameState.liveFishInventory[baitId] || 0) - 1);
            }
        }

        function handleFishingSuccess(fish) {
            const weight = fish.weightRange.min + Math.random() * (fish.weightRange.max - fish.weightRange.min);
            const price = Math.floor(fish.basePrice * (1 + weight / 10));

            // æ›´æ–°å·²é’“é±¼è®°å½•
            const fishRecord = gameState.caughtFish[fish.id] || { count: 0, firstCaught: Date.now(), maxWeight: 0 };
            gameState.caughtFish[fish.id] = {
                count: fishRecord.count + 1,
                firstCaught: fishRecord.firstCaught,
                maxWeight: Math.max(fishRecord.maxWeight, weight)
            };

            // æ·»åŠ åˆ°æ´»é±¼åº“å­˜
            if (fish.canBeBait) {
                gameState.liveFishInventory[fish.id] = (gameState.liveFishInventory[fish.id] || 0) + 1;
            }

            // æ›´æ–°æˆå°±
            if (fish.id === 'giant_squid' && !gameState.achievements.includes('deep_sea_conqueror')) {
                gameState.achievements.push('deep_sea_conqueror');
                addLog('ğŸ‰ è§£é”æˆå°±ï¼šæ·±æµ·å¾æœè€…ï¼', 'success');
            }
            if (fish.id === 'sperm_whale' && !gameState.achievements.includes('deep_sea_hunter')) {
                gameState.achievements.push('deep_sea_hunter');
                addLog('ğŸ‰ è§£é”æˆå°±ï¼šæ·±æµ·çŒäººï¼', 'success');
            }
            if (fish.id === 'cthulhu' && !gameState.achievements.includes('forbidden_touch')) {
                gameState.achievements.push('forbidden_touch');
                addLog('ğŸ‰ è§£é”æˆå°±ï¼šç¦å¿Œä¹‹è§¦ï¼', 'success');
            }

            // æ›´æ–°æ·±æµ·é˜¶æ®µ
            if (fish.id === 'giant_squid' && gameState.deepSeaStage !== 'completed' && gameState.deepSeaStage !== 'ultimate') {
                gameState.deepSeaStage = 'completed';
                addLog('ğŸ‰ æ·±æµ·æ¢ç´¢å®Œæˆï¼é’“åˆ°å¤§ç‹ä¹Œè´¼ï¼', 'success');
            }
            if (fish.id === 'cthulhu') {
                gameState.deepSeaStage = 'ultimate';
            }

            addLog(`ğŸ£ æˆåŠŸé’“åˆ° ${fish.name}ï¼é‡é‡: ${weight.toFixed(2)}kgï¼Œä»·å€¼: ${price}å…ƒ`, 'success');
            saveGameState();
            
            // å¦‚æœä¸åœ¨åœºæ™¯ä¸­ï¼Œæ›´æ–°UI
            if (document.querySelector('.container').style.display !== 'none') {
                updateUI();
            }
        }

        function handleCapsize() {
            gameState.baitInventory = { plant: 0, dead_fish: 0 };
            gameState.liveFishInventory = {};
            gameState.deathCount = (gameState.deathCount || 0) + 1;
            showMessage('ğŸ’¥ ç¿»èˆ¹äº†ï¼æ‰€æœ‰é±¼é¥µå’Œé±¼éƒ½ä¸¢å¤±äº†ã€‚è¿”å›å²¸è¾¹ã€‚', 'error');
            saveGameState();
            updateUI();
        }

        function handleDeepSeaFailure() {
            gameState.gameOver = true;
            gameState.deathCount = (gameState.deathCount || 0) + 1;
            showMessage('ğŸ’€ æ·±æµ·é’“é±¼å¤±è´¥ã€‚æ¸¸æˆç»“æŸã€‚', 'error');
            saveGameState();
            showSettlement();
        }

        // ========== å•†åº—åŠŸèƒ½ ==========
        function purchaseBoat(boatId) {
            const boat = BOAT_CONFIG[boatId];
            if (!boat) return;

            const boatOrder = ['none', 'small', 'medium', 'large'];
            const currentIndex = boatOrder.indexOf(gameState.boat);
            const newIndex = boatOrder.indexOf(boatId);

            if (newIndex <= currentIndex) {
                showMessage('å·²ç»æ‹¥æœ‰æ­¤èˆ¹åªæˆ–æ›´å¥½çš„èˆ¹åª', 'error');
                return;
            }

            if (gameState.money < boat.price) {
                showMessage('èµ„é‡‘ä¸è¶³', 'error');
                return;
            }

            gameState.money -= boat.price;
            gameState.boat = boatId;
            showMessage(`âœ… è´­ä¹°äº† ${boat.name}`, 'success');
            saveGameState();
            updateUI();
        }

        function purchaseBait(baitId, quantity = 1) {
            const bait = BAIT_CONFIG[baitId];
            if (!bait) return;

            const totalCost = bait.price * quantity;
            if (gameState.money < totalCost) {
                showMessage('èµ„é‡‘ä¸è¶³', 'error');
                return;
            }

            gameState.money -= totalCost;
            gameState.baitInventory[baitId] = (gameState.baitInventory[baitId] || 0) + quantity;
            showMessage(`âœ… è´­ä¹°äº† ${quantity} ä¸ª ${bait.name}`, 'success');
            saveGameState();
            updateUI();
        }

        function purchaseConsumable(consumableId, quantity = 1) {
            const consumable = CONSUMABLE_CONFIG[consumableId];
            if (!consumable) return;

            const totalCost = consumable.price * quantity;
            if (gameState.money < totalCost) {
                showMessage('èµ„é‡‘ä¸è¶³', 'error');
                return;
            }

            gameState.money -= totalCost;
            gameState.consumables[consumableId] = (gameState.consumables[consumableId] || 0) + quantity;
            showMessage(`âœ… è´­ä¹°äº† ${quantity} ä¸ª ${consumable.name}`, 'success');
            saveGameState();
            updateUI();
        }

        // ========== UI æ›´æ–° ==========
        function updateUI() {
            // æ›´æ–°åŸºæœ¬ä¿¡æ¯
            document.getElementById('money').textContent = gameState.money;
            document.getElementById('boat').textContent = BOAT_CONFIG[gameState.boat].name;
            document.getElementById('caughtCount').textContent = Object.keys(gameState.caughtFish).length;
            document.getElementById('achievementCount').textContent = gameState.achievements.length;

            // æ›´æ–°ç¯å¢ƒé€‰æ‹©
            updateEnvironmentSelect();

            // æ›´æ–°é±¼ç±»é€‰æ‹©
            updateFishSelect();

            // æ›´æ–°é±¼é¥µé€‰æ‹©
            updateBaitSelect();

            // æ›´æ–°å•†åº—
            updateShop();

            // æ›´æ–°åº“å­˜
            updateInventory();

            // æ›´æ–°æˆå°±
            updateAchievements();
        }

        function updateEnvironmentSelect() {
            const select = document.getElementById('environmentSelect');
            select.innerHTML = '';
            Object.values(ENVIRONMENT_CONFIG).forEach(env => {
                if (canBoatAccessEnvironment(gameState.boat, env.id)) {
                    const option = document.createElement('option');
                    option.value = env.id;
                    option.textContent = env.name;
                    select.appendChild(option);
                }
            });
            select.dispatchEvent(new Event('change'));
        }

        function updateFishSelect() {
            const select = document.getElementById('fishSelect');
            const environmentId = document.getElementById('environmentSelect').value;
            const fishList = getFishByEnvironment(environmentId);
            
            select.innerHTML = '<option value="">-- é€‰æ‹©é±¼ç±» --</option>';
            fishList.forEach(fish => {
                const option = document.createElement('option');
                option.value = fish.id;
                option.textContent = `${fish.name} (éš¾åº¦${fish.difficulty})`;
                select.appendChild(option);
            });
        }

        function updateBaitSelect() {
            const select = document.getElementById('baitSelect');
            const fishId = document.getElementById('fishSelect').value;
            const fish = FISH_CONFIG[fishId];
            
            select.innerHTML = '<option value="">-- é€‰æ‹©é±¼é¥µ --</option>';

            if (fish) {
                if (fish.requiredBaitType === 'plant') {
                    if (gameState.baitInventory.plant > 0) {
                        const option = document.createElement('option');
                        option.value = 'plant';
                        option.textContent = `æ¤ç‰©æ€§é¥µæ–™ (${gameState.baitInventory.plant}ä¸ª)`;
                        select.appendChild(option);
                    }
                } else if (fish.requiredBaitType === 'live_fish') {
                    // æ˜¾ç¤ºå¯ç”¨çš„æ´»é±¼
                    Object.keys(gameState.liveFishInventory).forEach(fishId => {
                        const count = gameState.liveFishInventory[fishId];
                        if (count > 0) {
                            if (!fish.requiredSpecificBait || fish.requiredSpecificBait.includes(fishId)) {
                                const option = document.createElement('option');
                                option.value = fishId;
                                option.textContent = `${FISH_CONFIG[fishId].name} (${count}ä¸ª)`;
                                select.appendChild(option);
                            }
                        }
                    });
                    // ä¹Ÿå¯ä»¥ä½¿ç”¨æ­»é±¼
                    if (gameState.baitInventory.dead_fish > 0) {
                        const option = document.createElement('option');
                        option.value = 'dead_fish';
                        option.textContent = `é±¼å—ï¼ˆæ­»é±¼ï¼‰ (${gameState.baitInventory.dead_fish}ä¸ª)`;
                        select.appendChild(option);
                    }
                }
            }
        }

        function updateShop() {
            // èˆ¹åªå•†åº—
            const boatShop = document.getElementById('boatShop');
            boatShop.innerHTML = '';
            Object.values(BOAT_CONFIG).forEach(boat => {
                if (boat.id === 'none') return;
                const boatOrder = ['none', 'small', 'medium', 'large'];
                const currentIndex = boatOrder.indexOf(gameState.boat);
                const boatIndex = boatOrder.indexOf(boat.id);
                const canBuy = boatIndex > currentIndex && gameState.money >= boat.price;
                
                const div = document.createElement('div');
                div.className = 'boat-item';
                div.innerHTML = `
                    <h3>${boat.name}</h3>
                    <p>ä»·æ ¼: ${boat.price}å…ƒ</p>
                    <button class="button" ${!canBuy ? 'disabled' : ''} onclick="purchaseBoat('${boat.id}')">è´­ä¹°</button>
                `;
                boatShop.appendChild(div);
            });

            // é±¼é¥µå•†åº—
            const baitShop = document.getElementById('baitShop');
            baitShop.innerHTML = '';
            Object.values(BAIT_CONFIG).forEach(bait => {
                const div = document.createElement('div');
                div.className = 'bait-item';
                div.innerHTML = `
                    <h3>${bait.name}</h3>
                    <p>ä»·æ ¼: ${bait.price}å…ƒ/ä¸ª</p>
                    <button class="button" onclick="purchaseBait('${bait.id}', 1)">ä¹°1ä¸ª</button>
                    <button class="button" onclick="purchaseBait('${bait.id}', 10)">ä¹°10ä¸ª</button>
                `;
                baitShop.appendChild(div);
            });

            // æ¶ˆè€—å“å•†åº—
            const consumableShop = document.getElementById('consumableShop');
            consumableShop.innerHTML = '';
            Object.values(CONSUMABLE_CONFIG).forEach(consumable => {
                const div = document.createElement('div');
                div.className = 'bait-item';
                div.innerHTML = `
                    <h3>${consumable.name}</h3>
                    <p>ä»·æ ¼: ${consumable.price}å…ƒ/ä¸ª</p>
                    <button class="button" onclick="purchaseConsumable('${consumable.id}', 1)">ä¹°1ä¸ª</button>
                `;
                consumableShop.appendChild(div);
            });
        }

        function updateInventory() {
            // é±¼é¥µåº“å­˜
            const baitInventory = document.getElementById('baitInventory');
            baitInventory.innerHTML = '';
            Object.keys(BAIT_CONFIG).forEach(baitId => {
                const count = gameState.baitInventory[baitId] || 0;
                if (count > 0) {
                    const div = document.createElement('div');
                    div.className = 'bait-item';
                    div.innerHTML = `<strong>${BAIT_CONFIG[baitId].name}:</strong> ${count}ä¸ª`;
                    baitInventory.appendChild(div);
                }
            });

            // æ´»é±¼åº“å­˜
            const liveFishInventory = document.getElementById('liveFishInventory');
            liveFishInventory.innerHTML = '';
            Object.keys(gameState.liveFishInventory).forEach(fishId => {
                const count = gameState.liveFishInventory[fishId];
                if (count > 0) {
                    const div = document.createElement('div');
                    div.className = 'fish-item';
                    div.innerHTML = `<strong>${FISH_CONFIG[fishId].name}:</strong> ${count}ä¸ª (å¯ç”¨ä½œé±¼é¥µ)`;
                    liveFishInventory.appendChild(div);
                }
            });
        }

        function updateAchievements() {
            const area = document.getElementById('achievementsArea');
            area.innerHTML = '';
            Object.values(ACHIEVEMENT_CONFIG).forEach(achievement => {
                const hasAchievement = gameState.achievements.includes(achievement.id);
                const div = document.createElement('div');
                div.className = `achievement ${hasAchievement ? '' : 'locked'}`;
                div.textContent = hasAchievement ? achievement.name : `${achievement.name} (æœªè§£é”)`;
                area.appendChild(div);
            });
        }

        function showMessage(message, type = 'info') {
            const area = document.getElementById('messageArea');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = message;
            area.appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        function showSettlement() {
            const settlement = getSettlement();
            const content = document.getElementById('settlementContent');
            content.innerHTML = `
                <div class="settlement-item">
                    <strong>ç§°å·:</strong> ${settlement.achievements.map(a => a.name).join(', ')}
                </div>
                <div class="settlement-item">
                    <strong>é’“åˆ°é±¼ç§:</strong> ${settlement.fishSpeciesCaught} / ${settlement.totalFishSpecies}
                </div>
                <div class="settlement-item">
                    <strong>æœ€ç¨€æœ‰é±¼:</strong> ${settlement.rarestFish ? settlement.rarestFish.name : 'æ— '}
                </div>
                <div class="settlement-item">
                    <strong>æœ€å¤§å•é±¼ä»·å€¼:</strong> ${settlement.maxValueFish ? settlement.maxValueFish.value + 'å…ƒ (' + settlement.maxValueFish.name + ')' : 'æ— '}
                </div>
                <div class="settlement-item">
                    <strong>æ€»æ¸¸æˆæ—¶é—´:</strong> ${Math.floor(settlement.totalGameTime / 60)}åˆ†é’Ÿ
                </div>
                <div class="settlement-item">
                    <strong>æ­»äº¡æ¬¡æ•°:</strong> ${settlement.deathCount}
                </div>
            `;
            document.getElementById('settlementModal').classList.add('active');
        }

        function closeSettlement() {
            document.getElementById('settlementModal').classList.remove('active');
        }

        function getSettlement() {
            const caughtCount = Object.keys(gameState.caughtFish).length;
            const allFishIds = Object.keys(FISH_CONFIG);
            
            let rarestFish = null;
            let maxDifficulty = 0;
            Object.keys(gameState.caughtFish).forEach(fishId => {
                const fish = FISH_CONFIG[fishId];
                if (fish && fish.difficulty > maxDifficulty) {
                    maxDifficulty = fish.difficulty;
                    rarestFish = { id: fish.id, name: fish.name, difficulty: fish.difficulty };
                }
            });

            let maxValue = 0;
            let maxValueFish = null;
            Object.keys(gameState.caughtFish).forEach(fishId => {
                const fish = FISH_CONFIG[fishId];
                if (fish) {
                    const record = gameState.caughtFish[fishId];
                    const estimatedValue = fish.basePrice * (1 + record.maxWeight / 10);
                    if (estimatedValue > maxValue) {
                        maxValue = estimatedValue;
                        maxValueFish = { id: fish.id, name: fish.name, value: Math.floor(estimatedValue) };
                    }
                }
            });

            const achievements = gameState.achievements.map(id => ({
                id,
                name: ACHIEVEMENT_CONFIG[id]?.name || id
            }));

            const timeDiff = Math.floor((Date.now() - gameState.lastUpdateTime) / 1000);
            const totalGameTime = gameState.gameTime + timeDiff;

            return {
                achievements,
                fishSpeciesCaught: caughtCount,
                totalFishSpecies: allFishIds.length,
                rarestFish,
                maxValueFish,
                totalGameTime,
                deathCount: gameState.deathCount || 0
            };
        }

        function resetGame() {
            if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹æ¸¸æˆå—ï¼Ÿæ‰€æœ‰è¿›åº¦å°†ä¸¢å¤±ï¼')) {
                resetGameState();
                closeSettlement();
                showMessage('æ¸¸æˆå·²é‡ç½®', 'success');
            }
        }

        function endGame() {
            gameState.gameOver = true;
            saveGameState();
            showSettlement();
        }

        // ========== äº‹ä»¶ç›‘å¬ ==========
        document.getElementById('environmentSelect').addEventListener('change', updateFishSelect);
        document.getElementById('fishSelect').addEventListener('change', updateBaitSelect);

        // ========== æ–°å¢åŠŸèƒ½å‡½æ•° ==========
        
        // æ¸¸æˆæ—¥å¿—
        let gameLog = [];
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            gameLog.unshift({ timestamp, message, type });
            if (gameLog.length > 20) gameLog.pop();
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logArea = document.getElementById('gameLog');
            logArea.innerHTML = gameLog.map(log => 
                `<div style="margin: 5px 0; padding: 5px; border-left: 3px solid ${
                    log.type === 'success' ? '#4facfe' : 
                    log.type === 'error' ? '#f5576c' : 
                    log.type === 'warning' ? '#ffa726' : '#667eea'
                };">
                    <span style="color: #667eea;">[${log.timestamp}]</span> ${log.message}
                </div>`
            ).join('');
        }

        // åœ°å›¾å¯è§†åŒ–
        function openMap() {
            const content = document.getElementById('mapContent');
            content.innerHTML = '';
            Object.values(ENVIRONMENT_CONFIG).forEach(env => {
                const accessible = canBoatAccessEnvironment(gameState.boat, env.id);
                const div = document.createElement('div');
                div.className = 'panel';
                div.style.opacity = accessible ? '1' : '0.5';
                div.style.border = accessible ? '2px solid #667eea' : '2px solid #666';
                div.innerHTML = `
                    <h3 style="color: ${accessible ? '#667eea' : '#666'};">
                        ${env.name} ${accessible ? 'âœ“' : 'ğŸ”’'}
                    </h3>
                    <p style="font-size: 0.9em; color: #a0a0a0;">
                        ${env.hasCapsizeRisk ? 'âš ï¸ æœ‰ç¿»èˆ¹é£é™©' : 'âœ“ å®‰å…¨æ°´åŸŸ'}
                    </p>
                    <p style="font-size: 0.8em; color: #888;">
                        ${getFishByEnvironment(env.id).length} ç§é±¼ç±»
                    </p>
                `;
                content.appendChild(div);
            });
            document.getElementById('mapModal').classList.add('active');
        }

        function closeMap() {
            document.getElementById('mapModal').classList.remove('active');
        }

        // è®¾ç½®é¢æ¿
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function toggleSound() {
            const enabled = document.getElementById('soundEnabled').checked;
            localStorage.setItem('cyberFishing_soundEnabled', enabled);
        }

        function toggleMusic() {
            const enabled = document.getElementById('musicEnabled').checked;
            localStorage.setItem('cyberFishing_musicEnabled', enabled);
        }

        function setVolume(value) {
            document.getElementById('volumeValue').textContent = value;
            localStorage.setItem('cyberFishing_volume', value);
        }

        // å›¾é‰´ç³»ç»Ÿ
        function openEncyclopedia() {
            const content = document.getElementById('encyclopediaContent');
            content.innerHTML = '';
            Object.values(FISH_CONFIG).forEach(fish => {
                const caught = gameState.caughtFish[fish.id];
                const div = document.createElement('div');
                div.className = 'panel';
                div.style.opacity = caught ? '1' : '0.6';
                div.innerHTML = `
                    <h3 style="color: ${caught ? '#667eea' : '#666'};">
                        ${fish.name} ${caught ? 'âœ“' : 'â“'}
                    </h3>
                    <p style="font-size: 0.9em; color: #a0a0a0;">
                        éš¾åº¦: ${fish.difficulty} | ç¯å¢ƒ: ${ENVIRONMENT_CONFIG[fish.environment].name}
                    </p>
                    <p style="font-size: 0.9em; color: #a0a0a0;">
                        ç±»å‹: ${fish.type === 'herbivore' ? 'æ¤é£Ÿ' : fish.type === 'carnivore' ? 'è‚‰é£Ÿ' : 'æ·±æµ·æ é£Ÿ'}
                    </p>
                    <p style="font-size: 0.9em; color: #a0a0a0;">
                        åŸºç¡€ä»·æ ¼: ${fish.basePrice}å…ƒ
                    </p>
                    ${caught ? `
                        <p style="font-size: 0.9em; color: #4facfe; margin-top: 10px;">
                            å·²æ•è·: ${caught.count}æ¬¡ | æœ€å¤§é‡é‡: ${caught.maxWeight.toFixed(2)}kg
                        </p>
                    ` : '<p style="font-size: 0.8em; color: #888; margin-top: 10px;">æœªå‘ç°</p>'}
                `;
                content.appendChild(div);
            });
            document.getElementById('encyclopediaModal').classList.add('active');
        }

        function closeEncyclopedia() {
            document.getElementById('encyclopediaModal').classList.remove('active');
        }

        // æˆå°±å¢™
        function openAchievements() {
            const content = document.getElementById('achievementsWall');
            content.innerHTML = '';
            Object.values(ACHIEVEMENT_CONFIG).forEach(achievement => {
                const hasAchievement = gameState.achievements.includes(achievement.id);
                const div = document.createElement('div');
                div.className = 'panel';
                div.style.opacity = hasAchievement ? '1' : '0.5';
                div.style.border = hasAchievement ? '2px solid #667eea' : '2px solid #666';
                div.innerHTML = `
                    <h3 style="color: ${hasAchievement ? '#667eea' : '#666'};">
                        ${hasAchievement ? 'ğŸ†' : 'ğŸ”’'} ${achievement.name}
                    </h3>
                    <p style="font-size: 0.9em; color: #a0a0a0;">
                        ${hasAchievement ? 'å·²è§£é”' : 'æœªè§£é”'}
                    </p>
                `;
                content.appendChild(div);
            });
            document.getElementById('achievementsModal').classList.add('active');
        }

        function closeAchievements() {
            document.getElementById('achievementsModal').classList.remove('active');
        }

        // å¸®åŠ©ç³»ç»Ÿ
        function openHelp() {
            document.getElementById('helpModal').classList.add('active');
        }

        function closeHelp() {
            document.getElementById('helpModal').classList.remove('active');
        }

        // é£é™©è­¦å‘Šå¼¹çª—
        let pendingRiskAction = null;
        function showRiskWarning(message, onConfirm) {
            document.getElementById('riskModalContent').innerHTML = message;
            pendingRiskAction = onConfirm;
            document.getElementById('riskModal').classList.add('active');
        }

        function confirmRisk() {
            if (pendingRiskAction) {
                pendingRiskAction();
                pendingRiskAction = null;
            }
            document.getElementById('riskModal').classList.remove('active');
        }

        function cancelRisk() {
            pendingRiskAction = null;
            document.getElementById('riskModal').classList.remove('active');
        }

        // æ›´æ–°æ·±æµ·é˜¶æ®µè¿›åº¦
        function updateDeepSeaProgress() {
            const panel = document.getElementById('deepSeaProgressPanel');
            if (gameState.deepSeaStage === 'none') {
                panel.style.display = 'none';
                return;
            }
            panel.style.display = 'block';
            
            const stageText = {
                'none': 'æœªå¼€å§‹',
                'exploring': 'æ¢ç´¢ä¸­',
                'completed': 'å·²å®Œæˆ',
                'ultimate': 'ç»ˆæ'
            };
            
            document.getElementById('deepSeaStageText').textContent = stageText[gameState.deepSeaStage] || 'æœªçŸ¥';
            
            const progress = {
                'none': 0,
                'exploring': 33,
                'completed': 66,
                'ultimate': 100
            };
            
            const progressValue = progress[gameState.deepSeaStage] || 0;
            document.getElementById('deepSeaProgressText').textContent = progressValue + '%';
            document.getElementById('deepSeaProgressBar').style.width = progressValue + '%';
            document.getElementById('deepSeaProgressBar').textContent = progressValue + '%';
        }

        // ä¿®æ”¹showMessageå‡½æ•°ï¼Œæ·»åŠ æ—¥å¿—
        const originalShowMessage = showMessage;
        showMessage = function(message, type = 'info') {
            originalShowMessage(message, type);
            addLog(message, type);
        };

        // ä¿®æ”¹checkRiskå‡½æ•°ï¼Œæ·»åŠ é£é™©è­¦å‘Šå¼¹çª—
        const originalCheckRisk = checkRisk;
        checkRisk = function() {
            const environmentId = document.getElementById('environmentSelect').value;
            const fishId = document.getElementById('fishSelect').value;
            const baitId = document.getElementById('baitSelect').value;
            const useConsumable = document.getElementById('useConsumable').checked;

            if (!fishId || !baitId) {
                showMessage('è¯·é€‰æ‹©ç›®æ ‡é±¼ç±»å’Œé±¼é¥µ', 'error');
                return;
            }

            const fish = FISH_CONFIG[fishId];
            const successRate = calculateSuccessRate(fish, baitId, useConsumable);
            const capsizeInfo = checkCapsizeRisk(environmentId, gameState.boat, fish, successRate);

            let warning = `<div class="message info">æˆåŠŸç‡: ${successRate.toFixed(1)}%</div>`;
            let riskMessage = '';
            
            if (capsizeInfo.risk) {
                warning += `<div class="message warning">âš ï¸ ${capsizeInfo.message}</div>`;
                riskMessage += `<p style="color: #f5576c; font-weight: bold;">âš ï¸ ${capsizeInfo.message}</p>`;
            }
            
            if (environmentId === 'deep_sea') {
                if (gameState.boat !== 'large') {
                    warning += `<div class="message error">âŒ æ— æ³•è¿›å…¥æ·±æµ·ï¼Œéœ€è¦å¤§èˆ¹ã€‚æ¸¸æˆå°†ç»“æŸã€‚</div>`;
                    riskMessage += `<p style="color: #f5576c; font-weight: bold;">âŒ æ— æ³•è¿›å…¥æ·±æµ·ï¼Œéœ€è¦å¤§èˆ¹ã€‚æ¸¸æˆå°†ç»“æŸã€‚</p>`;
                } else {
                    warning += `<div class="message warning">âš ï¸ æ·±æµ·é’“é±¼ï¼šå¤§èˆ¹æœ‰5%å¤±è´¥é£é™©ï¼ˆæ¸¸æˆç»“æŸï¼‰</div>`;
                    riskMessage += `<p style="color: #ffa726; font-weight: bold;">âš ï¸ æ·±æµ·é’“é±¼ï¼šå¤§èˆ¹æœ‰5%å¤±è´¥é£é™©ï¼ˆæ¸¸æˆç»“æŸï¼‰</p>`;
                }
            }

            document.getElementById('riskWarning').innerHTML = warning;
            
            // å¦‚æœæœ‰é«˜é£é™©ï¼Œæ˜¾ç¤ºè­¦å‘Šå¼¹çª—
            if (capsizeInfo.risk && capsizeInfo.shouldCapsize || environmentId === 'deep_sea') {
                showRiskWarning(riskMessage || 'å­˜åœ¨é«˜é£é™©ï¼Œè¯·è°¨æ…æ“ä½œï¼', () => {
                    // ç”¨æˆ·ç¡®è®¤åå¯ä»¥ç»§ç»­
                });
            }
        };

        // ========== é’“é±¼åœºæ™¯ç³»ç»Ÿ ==========
        let currentFishingState = {
            environmentId: null,
            fishId: null,
            baitId: null,
            useConsumable: false,
            successRate: 0,
            isCasting: false,
            isWaiting: false,
            biteTime: null,
            timingWindow: { start: 0, end: 0 },
            timingMarker: null
        };

        function startFishingScene() {
            const environmentId = document.getElementById('environmentSelect').value;
            const fishId = document.getElementById('fishSelect').value;
            const baitId = document.getElementById('baitSelect').value;
            const useConsumable = document.getElementById('useConsumable').checked;

            if (!fishId || !baitId) {
                showMessage('è¯·é€‰æ‹©ç›®æ ‡é±¼ç±»å’Œé±¼é¥µ', 'error');
                return;
            }

            // æ£€æŸ¥èˆ¹åªè®¿é—®æƒé™
            if (!canBoatAccessEnvironment(gameState.boat, environmentId)) {
                showMessage('å½“å‰èˆ¹åªæ— æ³•è¿›å…¥æ­¤æ°´åŸŸ', 'error');
                return;
            }

            const fish = FISH_CONFIG[fishId];
            if (!fish || fish.environment !== environmentId) {
                showMessage('æ— æ•ˆçš„é±¼ç±»é€‰æ‹©', 'error');
                return;
            }

            // éªŒè¯é±¼é¥µ
            const baitCheck = validateBait(baitId, fish);
            if (!baitCheck.valid) {
                showMessage(baitCheck.error, 'error');
                return;
            }

            // æ£€æŸ¥æ¶ˆè€—å“
            if (useConsumable && (!gameState.consumables?.lucky_charm || gameState.consumables.lucky_charm <= 0)) {
                showMessage('æ²¡æœ‰å¹¸è¿ç¬¦', 'error');
                return;
            }

            // è®¡ç®—æˆåŠŸç‡
            const successRate = calculateSuccessRate(fish, baitId, useConsumable);

            // æ·±æµ·è¿›å…¥æ£€æŸ¥ï¼ˆåœ¨è¿›å…¥åœºæ™¯å‰ï¼‰
            if (environmentId === 'deep_sea') {
                if (gameState.boat !== 'large') {
                    handleDeepSeaFailure();
                    return;
                }
                if (Math.random() < 0.05) {
                    handleDeepSeaFailure();
                    return;
                }
            }

            // æ£€æŸ¥æˆå°±ï¼ˆè¿›å…¥æ–°ç¯å¢ƒï¼‰
            if (environmentId === 'bay' && !gameState.achievements.includes('bay_adventurer')) {
                gameState.achievements.push('bay_adventurer');
            }
            if (environmentId === 'deep_sea') {
                if (!gameState.achievements.includes('deep_sea_explorer')) {
                    gameState.achievements.push('deep_sea_explorer');
                }
                if (gameState.deepSeaStage === 'none') {
                    gameState.deepSeaStage = 'exploring';
                }
            }

            // ä¿å­˜å½“å‰é’“é±¼çŠ¶æ€
            currentFishingState = {
                environmentId,
                fishId,
                baitId,
                useConsumable,
                successRate,
                isCasting: false,
                isWaiting: false,
                biteTime: null,
                timingWindow: { start: 0, end: 0 },
                timingMarker: null,
                waitStartTime: null
            };

            // è®¾ç½®åœºæ™¯èƒŒæ™¯
            const sceneBackground = document.getElementById('sceneBackground');
            sceneBackground.className = 'scene-background ' + environmentId;

            // æ›´æ–°åœºæ™¯ä¿¡æ¯
            document.getElementById('sceneEnvironmentName').textContent = ENVIRONMENT_CONFIG[environmentId].name;
            document.getElementById('sceneTargetFish').textContent = `ç›®æ ‡ï¼š${fish.name}`;

            // æ˜¾ç¤ºåœºæ™¯
            document.getElementById('fishingScene').style.display = 'block';
            document.querySelector('.container').style.display = 'none';

            // é‡ç½®çŠ¶æ€
            resetFishingScene();
            addLog(`è¿›å…¥${ENVIRONMENT_CONFIG[environmentId].name}å¼€å§‹é’“é±¼`, 'info');
        }

        function resetFishingScene() {
            document.getElementById('fishingStatus').textContent = 'å‡†å¤‡ç”©æ†...';
            document.getElementById('fishingTimer').textContent = '';
            document.getElementById('castBtn').style.display = 'block';
            document.getElementById('reelBtn').style.display = 'none';
            document.getElementById('timingIndicator').style.display = 'none';
            document.getElementById('fishingResult').style.display = 'none';
            
            const float = document.getElementById('float');
            float.classList.remove('biting', 'strong-bite', 'casting');
            float.style.display = 'none';
        }

        function castFishingRod() {
            if (currentFishingState.isCasting || currentFishingState.isWaiting) return;

            currentFishingState.isCasting = true;
            document.getElementById('castBtn').style.display = 'none';
            document.getElementById('fishingStatus').textContent = 'ç”©æ†ä¸­...';

            const float = document.getElementById('float');
            float.style.display = 'block';
            float.classList.add('casting');

            // ç”©æ†åŠ¨ç”»å®Œæˆå
            setTimeout(() => {
                float.classList.remove('casting');
                currentFishingState.isCasting = false;
                currentFishingState.isWaiting = true;
                startWaitingForBite();
            }, 1000);
        }

        function startWaitingForBite() {
            document.getElementById('fishingStatus').textContent = 'ç­‰å¾…é±¼å„¿ä¸Šé’©...';
            
            const fish = FISH_CONFIG[currentFishingState.fishId];
            const waitTime = 2000 + Math.random() * 3000; // 2-5ç§’ç­‰å¾…
            const biteWindow = 1000 + (fish.difficulty * 200); // éš¾åº¦è¶Šé«˜ï¼Œçª—å£è¶Šå°
            
            // è®¡ç®—å’¬é’©æ—¶é—´çª—å£ï¼ˆç›¸å¯¹äºå¼€å§‹ç­‰å¾…çš„æ—¶é—´ï¼‰
            const startTime = Date.now();
            const biteTime = waitTime + Math.random() * 2000;
            const windowStart = biteTime - biteWindow / 2;
            const windowEnd = biteTime + biteWindow / 2;

            currentFishingState.biteTime = startTime + biteTime;
            currentFishingState.timingWindow = { 
                start: startTime + windowStart, 
                end: startTime + windowEnd 
            };
            currentFishingState.waitStartTime = startTime;

            let timer = setInterval(() => {
                const now = Date.now();
                const elapsed = now - startTime;
                const remaining = Math.max(0, Math.ceil((biteTime + biteWindow / 2 - elapsed) / 1000));
                document.getElementById('fishingTimer').textContent = remaining > 0 ? `é¢„è®¡${remaining}ç§’åå’¬é’©` : '';

                // æ¥è¿‘å’¬é’©æ—¶é—´ï¼Œå¼€å§‹æµ®æ¼‚åŠ¨ç”»
                if (elapsed >= biteTime - 1000 && elapsed < biteTime) {
                    const float = document.getElementById('float');
                    if (!float.classList.contains('biting')) {
                        float.classList.add('biting');
                    }
                }

                // æœ€ä½³å’¬é’©æ—¶æœº
                if (elapsed >= biteTime && elapsed < biteTime + 500) {
                    const float = document.getElementById('float');
                    float.classList.remove('biting');
                    if (!float.classList.contains('strong-bite')) {
                        float.classList.add('strong-bite');
                        showTimingIndicator();
                    }
                }

                // å’¬é’©çª—å£ç»“æŸ
                if (elapsed >= windowEnd) {
                    clearInterval(timer);
                    const float = document.getElementById('float');
                    float.classList.remove('biting', 'strong-bite');
                    if (!currentFishingState.timingMarker && currentFishingState.isWaiting) {
                        // é”™è¿‡æ—¶æœº
                        setTimeout(() => {
                            handleFishingMiss();
                        }, 500);
                    }
                }
            }, 100);
        }

        function showTimingIndicator() {
            document.getElementById('timingIndicator').style.display = 'block';
            document.getElementById('reelBtn').style.display = 'block';
            document.getElementById('fishingStatus').textContent = 'âš ï¸ æœ€ä½³æ”¶çº¿æ—¶æœºï¼';
            document.getElementById('fishingTimer').textContent = 'å¿«é€Ÿç‚¹å‡»æ”¶çº¿ï¼';

            // å¯åŠ¨æ—¶æœºæŒ‡ç¤ºå™¨åŠ¨ç”»
            const marker = document.getElementById('timingMarker');
            marker.style.animation = 'timingMarkerMove 2s linear infinite';
        }

        function reelIn() {
            if (!currentFishingState.isWaiting) return;

            const now = Date.now();
            const window = currentFishingState.timingWindow;
            
            // è®¡ç®—æ—¶æœºå‡†ç¡®æ€§
            let timingAccuracy = 0;
            if (window && now >= window.start && now <= window.end) {
                // åœ¨çª—å£å†…ï¼Œè®¡ç®—å‡†ç¡®åº¦
                const center = (window.start + window.end) / 2;
                const distance = Math.abs(now - center);
                const maxDistance = (window.end - window.start) / 2;
                timingAccuracy = Math.max(0, 1 - (distance / maxDistance));
            } else if (window && now < window.start) {
                // æ”¶çº¿å¤ªæ—©
                timingAccuracy = -0.5;
            } else {
                // æ”¶çº¿å¤ªæ™šæˆ–é”™è¿‡çª—å£
                timingAccuracy = -1;
            }

            currentFishingState.isWaiting = false;
            currentFishingState.timingMarker = timingAccuracy;

            // éšè—æµ®æ¼‚å’ŒæŒ‡ç¤ºå™¨
            document.getElementById('float').style.display = 'none';
            document.getElementById('timingIndicator').style.display = 'none';
            document.getElementById('reelBtn').style.display = 'none';

            // æ‰§è¡Œé’“é±¼ç»“æœ
            executeFishingResult(timingAccuracy);
        }

        function executeFishingResult(timingAccuracy) {
            const fish = FISH_CONFIG[currentFishingState.fishId];
            const successRate = currentFishingState.successRate;
            
            // æ—¶æœºå‡†ç¡®åº¦å½±å“æˆåŠŸç‡
            let finalSuccessRate = successRate;
            if (timingAccuracy > 0) {
                finalSuccessRate = Math.min(100, successRate + timingAccuracy * 20); // æœ€ä½³æ—¶æœº+20%
            } else if (timingAccuracy < 0) {
                finalSuccessRate = Math.max(0, successRate - 30); // é”™è¿‡æ—¶æœº-30%
            }

            const roll = Math.random() * 100;
            const fishingSuccess = roll < finalSuccessRate;

            // æ£€æŸ¥ç¿»èˆ¹é£é™©
            const capsizeInfo = checkCapsizeRisk(
                currentFishingState.environmentId, 
                gameState.boat, 
                fish, 
                finalSuccessRate
            );

            if (capsizeInfo.risk && !fishingSuccess && capsizeInfo.shouldCapsize) {
                handleCapsize();
                return;
            }

            // æ¶ˆè€—é±¼é¥µ
            consumeBait(currentFishingState.baitId);

            // æ¶ˆè€—æ¶ˆè€—å“
            if (currentFishingState.useConsumable) {
                gameState.consumables.lucky_charm = (gameState.consumables.lucky_charm || 0) - 1;
            }

            // æ˜¾ç¤ºç»“æœ
            showFishingResult(fishingSuccess, fish, timingAccuracy);
        }

        function showFishingResult(success, fish, timingAccuracy) {
            const resultDiv = document.getElementById('fishingResult');
            const contentDiv = document.getElementById('resultContent');
            
            resultDiv.style.display = 'block';
            
            if (success) {
                contentDiv.className = 'result-content success';
                const weight = fish.weightRange.min + Math.random() * (fish.weightRange.max - fish.weightRange.min);
                const price = Math.floor(fish.basePrice * (1 + weight / 10));
                
                contentDiv.innerHTML = `
                    <div style="font-size: 3em; margin-bottom: 20px;">ğŸ£</div>
                    <h2 style="color: #4facfe; margin-bottom: 15px;">æˆåŠŸé’“åˆ°ï¼</h2>
                    <p style="font-size: 1.2em; margin: 10px 0;">${fish.name}</p>
                    <p style="color: #a0a0a0; margin: 10px 0;">é‡é‡: ${weight.toFixed(2)}kg</p>
                    <p style="color: #4facfe; margin: 10px 0; font-size: 1.3em;">ä»·å€¼: ${price}å…ƒ</p>
                    ${timingAccuracy > 0.8 ? '<p style="color: #FFD700; margin-top: 15px;">â­ å®Œç¾æ—¶æœºï¼</p>' : ''}
                `;
                
                // handleFishingSuccessä¼šåœ¨å†…éƒ¨æ›´æ–°æ¸¸æˆçŠ¶æ€
                handleFishingSuccess(fish);
            } else {
                contentDiv.className = 'result-content failure';
                contentDiv.innerHTML = `
                    <div style="font-size: 3em; margin-bottom: 20px;">ğŸ˜”</div>
                    <h2 style="color: #f5576c; margin-bottom: 15px;">é’“é±¼å¤±è´¥</h2>
                    <p style="color: #a0a0a0; margin: 10px 0;">é±¼å„¿é€ƒè„±äº†...</p>
                    ${timingAccuracy < 0 ? '<p style="color: #ffa726; margin-top: 15px;">âš ï¸ é”™è¿‡äº†æœ€ä½³æ”¶çº¿æ—¶æœº</p>' : ''}
                `;
                addLog('é’“é±¼å¤±è´¥ï¼Œæ¶ˆè€—äº†1ä¸ªé±¼é¥µ', 'error');
            }
            
            saveGameState();
        }

        function handleFishingMiss() {
            if (!currentFishingState.isWaiting) return;
            currentFishingState.isWaiting = false;
            
            const resultDiv = document.getElementById('fishingResult');
            const contentDiv = document.getElementById('resultContent');
            
            resultDiv.style.display = 'block';
            contentDiv.className = 'result-content failure';
            contentDiv.innerHTML = `
                <div style="font-size: 3em; margin-bottom: 20px;">â°</div>
                <h2 style="color: #f5576c; margin-bottom: 15px;">é”™è¿‡æ—¶æœº</h2>
                <p style="color: #a0a0a0; margin: 10px 0;">æ²¡æœ‰åŠæ—¶æ”¶çº¿ï¼Œé±¼å„¿é€ƒèµ°äº†...</p>
            `;
            
            // æ¶ˆè€—é±¼é¥µ
            consumeBait(currentFishingState.baitId);
            addLog('é”™è¿‡æ”¶çº¿æ—¶æœºï¼Œé±¼å„¿é€ƒèµ°äº†', 'warning');
            saveGameState();
        }

        function continueFishing() {
            resetFishingScene();
        }

        function exitFishingScene() {
            document.getElementById('fishingScene').style.display = 'none';
            document.querySelector('.container').style.display = 'block';
            resetFishingScene();
            updateUI();
        }

        // æ·»åŠ è„‰å†²åŠ¨ç”»
        const style = document.createElement('style');
        style.textContent += `
            @keyframes pulse {
                0%, 100% { transform: scale(1); opacity: 1; }
                50% { transform: scale(1.2); opacity: 0.7; }
            }
        `;
        document.head.appendChild(style);

        // ä¿®æ”¹updateUIå‡½æ•°ï¼Œæ·»åŠ æ·±æµ·è¿›åº¦æ›´æ–°
        const originalUpdateUI = updateUI;
        updateUI = function() {
            originalUpdateUI();
            updateDeepSeaProgress();
        };

        // åˆå§‹åŒ–è®¾ç½®
        function initSettings() {
            const soundEnabled = localStorage.getItem('cyberFishing_soundEnabled');
            const musicEnabled = localStorage.getItem('cyberFishing_musicEnabled');
            const volume = localStorage.getItem('cyberFishing_volume');
            
            if (soundEnabled !== null) {
                document.getElementById('soundEnabled').checked = soundEnabled === 'true';
            }
            if (musicEnabled !== null) {
                document.getElementById('musicEnabled').checked = musicEnabled === 'true';
            }
            if (volume !== null) {
                document.getElementById('volumeSlider').value = volume;
                document.getElementById('volumeValue').textContent = volume;
            }
        }

        // ========== åˆå§‹åŒ– ==========
        loadGameState();
        initSettings();
        updateUI();
        addLog('æ¸¸æˆå·²åŠ è½½', 'info');
    </script>
</body>
</html>

