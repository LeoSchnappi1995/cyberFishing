<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberFishing - é’“é±¼æ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .game-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .info-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .info-item label {
            display: block;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .info-item .value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        .panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .button:active {
            transform: translateY(0);
        }

        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .button.danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .button.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        select, input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            margin: 5px 0;
        }

        .fish-list, .bait-list, .boat-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .fish-item, .bait-item, .boat-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .fish-item h3 {
            color: #667eea;
            margin-bottom: 5px;
        }

        .fish-item .info {
            font-size: 0.9em;
            color: #666;
        }

        .message {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .achievements {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .achievement {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .achievement.locked {
            background: #ccc;
            opacity: 0.5;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-content h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .settlement-item {
            padding: 10px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ£ CyberFishing</h1>
            <p>å›åˆåˆ¶ç­–ç•¥é’“é±¼æ¸¸æˆ</p>
        </div>

        <div class="game-info">
            <div class="info-item">
                <label>ğŸ’° é‡‘é’±</label>
                <div class="value" id="money">500</div>
            </div>
            <div class="info-item">
                <label>ğŸš¤ èˆ¹åª</label>
                <div class="value" id="boat">æ— èˆ¹</div>
            </div>
            <div class="info-item">
                <label>ğŸ£ å·²é’“é±¼ç§</label>
                <div class="value" id="caughtCount">0</div>
            </div>
            <div class="info-item">
                <label>ğŸ† ç§°å·</label>
                <div class="value" id="achievementCount">1</div>
            </div>
        </div>

        <div class="main-content">
            <!-- å·¦ä¾§ï¼šé’“é±¼åŒºåŸŸ -->
            <div class="panel">
                <h2>ğŸ£ é’“é±¼</h2>
                <div id="fishingArea">
                    <label>é€‰æ‹©æ°´åŸŸï¼š</label>
                    <select id="environmentSelect">
                        <option value="stream">æºªæµ</option>
                        <option value="river">æ±Ÿè¾¹</option>
                    </select>

                    <label>ç›®æ ‡é±¼ç±»ï¼š</label>
                    <select id="fishSelect"></select>

                    <label>é€‰æ‹©é±¼é¥µï¼š</label>
                    <select id="baitSelect"></select>

                    <label>
                        <input type="checkbox" id="useConsumable"> ä½¿ç”¨å¹¸è¿ç¬¦ (+10%)
                    </label>

                    <div id="riskWarning"></div>

                    <button class="button" onclick="checkRisk()">æ£€æŸ¥é£é™©</button>
                    <button class="button success" onclick="attemptFishing()">å¼€å§‹é’“é±¼</button>
                    <button class="button danger" onclick="endGame()" style="margin-top: 10px;">ç»“æŸæ¸¸æˆå¹¶ç»“ç®—</button>
                </div>
            </div>

            <!-- å³ä¾§ï¼šå•†åº—å’Œåº“å­˜ -->
            <div class="panel">
                <h2>ğŸª å•†åº—</h2>
                <div id="shopArea">
                    <h3>è´­ä¹°èˆ¹åª</h3>
                    <div id="boatShop"></div>

                    <h3>è´­ä¹°é±¼é¥µ</h3>
                    <div id="baitShop"></div>

                    <h3>è´­ä¹°æ¶ˆè€—å“</h3>
                    <div id="consumableShop"></div>
                </div>

                <h2 style="margin-top: 20px;">ğŸ“¦ åº“å­˜</h2>
                <div id="inventoryArea">
                    <h3>é±¼é¥µåº“å­˜</h3>
                    <div id="baitInventory"></div>

                    <h3>æ´»é±¼åº“å­˜ï¼ˆå¯ç”¨ä½œé±¼é¥µï¼‰</h3>
                    <div id="liveFishInventory"></div>
                </div>
            </div>
        </div>

        <!-- æˆå°±åŒºåŸŸ -->
        <div class="panel" style="margin: 20px;">
            <h2>ğŸ† æˆå°±ä¸ç§°å·</h2>
            <div id="achievementsArea" class="achievements"></div>
        </div>

        <!-- æ¶ˆæ¯åŒºåŸŸ -->
        <div id="messageArea" style="padding: 20px;"></div>

        <!-- ç»“ç®—æ¨¡æ€æ¡† -->
        <div class="modal" id="settlementModal">
            <div class="modal-content">
                <h2>æ¸¸æˆç»“ç®—</h2>
                <div id="settlementContent"></div>
                <button class="button" onclick="closeSettlement()">å…³é—­</button>
                <button class="button success" onclick="resetGame()">é‡æ–°å¼€å§‹</button>
            </div>
        </div>
    </div>

    <script>
        // ========== æ¸¸æˆé…ç½® ==========
        const FISH_CONFIG = {
            small_fish: { id: 'small_fish', name: 'å°é±¼', environment: 'stream', difficulty: 1, type: 'herbivore', requiredBaitType: 'plant', weightRange: { min: 0.1, max: 0.5 }, basePrice: 10, canBeBait: true },
            stream_fish: { id: 'stream_fish', name: 'æºªé±¼', environment: 'stream', difficulty: 2, type: 'herbivore', requiredBaitType: 'plant', weightRange: { min: 0.3, max: 0.8 }, basePrice: 25, canBeBait: true },
            catfish: { id: 'catfish', name: 'é²¶é±¼', environment: 'stream', difficulty: 3, type: 'carnivore', requiredBaitType: 'live_fish', weightRange: { min: 0.5, max: 2.0 }, basePrice: 50, canBeBait: true },
            river_carp: { id: 'river_carp', name: 'æ±Ÿé²¤', environment: 'river', difficulty: 2, type: 'herbivore', requiredBaitType: 'plant', weightRange: { min: 0.5, max: 1.5 }, basePrice: 30, canBeBait: true },
            river_pike: { id: 'river_pike', name: 'æ±Ÿé²ˆ', environment: 'river', difficulty: 3, type: 'carnivore', requiredBaitType: 'live_fish', weightRange: { min: 1.0, max: 3.0 }, basePrice: 60, canBeBait: true },
            lake_trout: { id: 'lake_trout', name: 'æ¹–é³Ÿ', environment: 'lake', difficulty: 3, type: 'carnivore', requiredBaitType: 'live_fish', weightRange: { min: 1.5, max: 4.0 }, basePrice: 80, canBeBait: true },
            lake_bass: { id: 'lake_bass', name: 'æ¹–é²ˆ', environment: 'lake', difficulty: 4, type: 'carnivore', requiredBaitType: 'live_fish', weightRange: { min: 2.0, max: 5.0 }, basePrice: 120, canBeBait: true },
            bay_tuna: { id: 'bay_tuna', name: 'æµ·æ¹¾é‡‘æªé±¼', environment: 'bay', difficulty: 4, type: 'carnivore', requiredBaitType: 'live_fish', weightRange: { min: 5.0, max: 15.0 }, basePrice: 200, canBeBait: true },
            bay_shark: { id: 'bay_shark', name: 'å¤§ç™½é²¨', environment: 'bay', difficulty: 5, type: 'deep_predator', requiredBaitType: 'live_fish', weightRange: { min: 50.0, max: 200.0 }, basePrice: 500, canBeBait: true },
            giant_squid: { id: 'giant_squid', name: 'å¤§ç‹ä¹Œè´¼', environment: 'deep_sea', difficulty: 5, type: 'deep_predator', requiredBaitType: 'live_fish', requiredSpecificBait: ['bay_shark', 'bay_tuna'], weightRange: { min: 100.0, max: 300.0 }, basePrice: 1000, canBeBait: true },
            sperm_whale: { id: 'sperm_whale', name: 'æŠ¹é¦™é²¸', environment: 'deep_sea', difficulty: 5, type: 'deep_predator', requiredBaitType: 'live_fish', requiredSpecificBait: ['giant_squid'], weightRange: { min: 500.0, max: 2000.0 }, basePrice: 2000, canBeBait: true },
            cthulhu: { id: 'cthulhu', name: 'å…‹è‹é²', environment: 'deep_sea', difficulty: 6, type: 'deep_predator', requiredBaitType: 'live_fish', requiredSpecificBait: ['sperm_whale'], weightRange: { min: 1000.0, max: 5000.0 }, basePrice: 5000, canBeBait: false }
        };

        const BOAT_CONFIG = {
            none: { id: 'none', name: 'æ— èˆ¹', price: 0, accessibleEnvironments: ['stream', 'river'] },
            small: { id: 'small', name: 'å°èˆ¹', price: 300, accessibleEnvironments: ['stream', 'river', 'lake'] },
            medium: { id: 'medium', name: 'ä¸­èˆ¹', price: 600, accessibleEnvironments: ['stream', 'river', 'lake', 'bay'] },
            large: { id: 'large', name: 'å¤§èˆ¹', price: 1200, accessibleEnvironments: ['stream', 'river', 'lake', 'bay', 'deep_sea'] }
        };

        const ENVIRONMENT_CONFIG = {
            stream: { id: 'stream', name: 'æºªæµ', unlockCondition: 'default', hasCapsizeRisk: false },
            river: { id: 'river', name: 'æ±Ÿè¾¹', unlockCondition: 'default', hasCapsizeRisk: false },
            lake: { id: 'lake', name: 'æ¹–æ³Š', unlockCondition: 'small_boat', hasCapsizeRisk: false },
            bay: { id: 'bay', name: 'æµ·æ¹¾', unlockCondition: 'medium_boat', hasCapsizeRisk: true },
            deep_sea: { id: 'deep_sea', name: 'æ·±æµ·', unlockCondition: 'large_boat', hasCapsizeRisk: true }
        };

        const ACHIEVEMENT_CONFIG = {
            beginner_angler: { id: 'beginner_angler', name: 'åˆå¿ƒé’“æ‰‹' },
            bay_adventurer: { id: 'bay_adventurer', name: 'æµ·æ¹¾å†’é™©è€…' },
            deep_sea_explorer: { id: 'deep_sea_explorer', name: 'æ·±æµ·æ¢è·¯è€…' },
            deep_sea_conqueror: { id: 'deep_sea_conqueror', name: 'æ·±æµ·å¾æœè€…' },
            deep_sea_hunter: { id: 'deep_sea_hunter', name: 'æ·±æµ·çŒäºº' },
            forbidden_touch: { id: 'forbidden_touch', name: 'ç¦å¿Œä¹‹è§¦' }
        };

        const BAIT_CONFIG = {
            plant: { id: 'plant', name: 'æ¤ç‰©æ€§é¥µæ–™', price: 5 },
            dead_fish: { id: 'dead_fish', name: 'é±¼å—ï¼ˆæ­»é±¼ï¼‰', price: 15 }
        };

        const CONSUMABLE_CONFIG = {
            lucky_charm: { id: 'lucky_charm', name: 'å¹¸è¿ç¬¦', price: 50 }
        };

        // ========== æ¸¸æˆçŠ¶æ€ ==========
        let gameState = {
            money: 500,
            boat: 'none',
            baitInventory: { plant: 0, dead_fish: 0 },
            liveFishInventory: {},
            caughtFish: {},
            achievements: ['beginner_angler'],
            gameStartTime: Date.now(),
            lastUpdateTime: Date.now(),
            gameTime: 0,
            deathCount: 0,
            deepSeaStage: 'none',
            gameOver: false,
            consumables: {}
        };

        // ========== æ•°æ®æŒä¹…åŒ– ==========
        function saveGameState() {
            gameState.lastUpdateTime = Date.now();
            const timeDiff = Math.floor((Date.now() - gameState.gameStartTime) / 1000);
            gameState.gameTime = timeDiff;
            localStorage.setItem('cyberFishing_gameState', JSON.stringify(gameState));
        }

        function loadGameState() {
            const saved = localStorage.getItem('cyberFishing_gameState');
            if (saved) {
                gameState = JSON.parse(saved);
                // æ›´æ–°æ¸¸æˆæ—¶é—´
                const timeDiff = Math.floor((Date.now() - gameState.lastUpdateTime) / 1000);
                gameState.gameTime += timeDiff;
                gameState.lastUpdateTime = Date.now();
            }
        }

        function resetGameState() {
            gameState = {
                money: 500,
                boat: 'none',
                baitInventory: { plant: 0, dead_fish: 0 },
                liveFishInventory: {},
                caughtFish: {},
                achievements: ['beginner_angler'],
                gameStartTime: Date.now(),
                lastUpdateTime: Date.now(),
                gameTime: 0,
                deathCount: 0,
                deepSeaStage: 'none',
                gameOver: false,
                consumables: {}
            };
            saveGameState();
            updateUI();
        }

        // ========== å·¥å…·å‡½æ•° ==========
        function canBoatAccessEnvironment(boatId, environmentId) {
            const boat = BOAT_CONFIG[boatId];
            return boat && boat.accessibleEnvironments.includes(environmentId);
        }

        function getFishByEnvironment(environmentId) {
            return Object.values(FISH_CONFIG).filter(fish => fish.environment === environmentId);
        }

        function calculateSuccessRate(fish, baitId, useConsumable) {
            let successRate = 60;
            const rodLevel = 1;
            const adjustment = (fish.difficulty - rodLevel) * 15;
            successRate -= adjustment;
            
            if (baitId !== 'plant' && baitId !== 'dead_fish') {
                successRate += 20; // æ´»é±¼ +20%
            }
            
            if (useConsumable) {
                successRate += 10; // å¹¸è¿ç¬¦ +10%
            }
            
            return Math.max(0, Math.min(100, successRate));
        }

        function checkCapsizeRisk(environmentId, boatId, fish, successRate) {
            if (environmentId === 'bay') {
                if (boatId === 'medium' && fish.difficulty >= 5 && successRate < 40) {
                    return { risk: true, shouldCapsize: true, message: 'é«˜é£é™©ï¼šä¸­èˆ¹ + éš¾åº¦5+ + æˆåŠŸç‡<40%ï¼Œå¯èƒ½ç¿»èˆ¹' };
                }
            }
            if (environmentId === 'deep_sea') {
                if (boatId !== 'large') {
                    return { risk: true, shouldCapsize: true, message: 'æ— æ³•è¿›å…¥æ·±æµ·ï¼Œéœ€è¦å¤§èˆ¹' };
                }
                return { risk: true, shouldCapsize: false, message: 'æ·±æµ·é’“é±¼ï¼šå¤§èˆ¹æœ‰5%å¤±è´¥é£é™©ï¼ˆæ¸¸æˆç»“æŸï¼‰' };
            }
            return { risk: false };
        }

        // ========== æ¸¸æˆé€»è¾‘ ==========
        function checkRisk() {
            const environmentId = document.getElementById('environmentSelect').value;
            const fishId = document.getElementById('fishSelect').value;
            const baitId = document.getElementById('baitSelect').value;
            const useConsumable = document.getElementById('useConsumable').checked;

            if (!fishId || !baitId) {
                showMessage('è¯·é€‰æ‹©ç›®æ ‡é±¼ç±»å’Œé±¼é¥µ', 'error');
                return;
            }

            const fish = FISH_CONFIG[fishId];
            const successRate = calculateSuccessRate(fish, baitId, useConsumable);
            const capsizeInfo = checkCapsizeRisk(environmentId, gameState.boat, fish, successRate);

            let warning = `<div class="message info">æˆåŠŸç‡: ${successRate.toFixed(1)}%</div>`;
            if (capsizeInfo.risk) {
                warning += `<div class="message warning">âš ï¸ ${capsizeInfo.message}</div>`;
            }
            if (environmentId === 'deep_sea') {
                if (gameState.boat !== 'large') {
                    warning += `<div class="message error">âŒ æ— æ³•è¿›å…¥æ·±æµ·ï¼Œéœ€è¦å¤§èˆ¹ã€‚æ¸¸æˆå°†ç»“æŸã€‚</div>`;
                } else {
                    warning += `<div class="message warning">âš ï¸ æ·±æµ·é’“é±¼ï¼šå¤§èˆ¹æœ‰5%å¤±è´¥é£é™©ï¼ˆæ¸¸æˆç»“æŸï¼‰</div>`;
                }
            }

            document.getElementById('riskWarning').innerHTML = warning;
        }

        function attemptFishing() {
            if (gameState.gameOver) {
                showMessage('æ¸¸æˆå·²ç»“æŸ', 'error');
                return;
            }

            const environmentId = document.getElementById('environmentSelect').value;
            const fishId = document.getElementById('fishSelect').value;
            const baitId = document.getElementById('baitSelect').value;
            const useConsumable = document.getElementById('useConsumable').checked;

            if (!fishId || !baitId) {
                showMessage('è¯·é€‰æ‹©ç›®æ ‡é±¼ç±»å’Œé±¼é¥µ', 'error');
                return;
            }

            // æ£€æŸ¥èˆ¹åªè®¿é—®æƒé™
            if (!canBoatAccessEnvironment(gameState.boat, environmentId)) {
                showMessage('å½“å‰èˆ¹åªæ— æ³•è¿›å…¥æ­¤æ°´åŸŸ', 'error');
                return;
            }

            const fish = FISH_CONFIG[fishId];
            if (!fish || fish.environment !== environmentId) {
                showMessage('æ— æ•ˆçš„é±¼ç±»é€‰æ‹©', 'error');
                return;
            }

            // æ£€æŸ¥æˆå°±ï¼ˆè¿›å…¥æ–°ç¯å¢ƒï¼‰
            if (environmentId === 'bay' && !gameState.achievements.includes('bay_adventurer')) {
                gameState.achievements.push('bay_adventurer');
            }
            if (environmentId === 'deep_sea') {
                if (!gameState.achievements.includes('deep_sea_explorer')) {
                    gameState.achievements.push('deep_sea_explorer');
                }
                if (gameState.deepSeaStage === 'none') {
                    gameState.deepSeaStage = 'exploring';
                }
            }

            // æ·±æµ·è¿›å…¥æ£€æŸ¥
            if (environmentId === 'deep_sea') {
                if (gameState.boat !== 'large') {
                    handleDeepSeaFailure();
                    return;
                }
                if (Math.random() < 0.05) {
                    handleDeepSeaFailure();
                    return;
                }
            }

            // éªŒè¯é±¼é¥µ
            const baitCheck = validateBait(baitId, fish);
            if (!baitCheck.valid) {
                showMessage(baitCheck.error, 'error');
                return;
            }

            // æ£€æŸ¥æ¶ˆè€—å“
            if (useConsumable && (!gameState.consumables?.lucky_charm || gameState.consumables.lucky_charm <= 0)) {
                showMessage('æ²¡æœ‰å¹¸è¿ç¬¦', 'error');
                return;
            }

            // è®¡ç®—æˆåŠŸç‡
            const successRate = calculateSuccessRate(fish, baitId, useConsumable);
            const roll = Math.random() * 100;
            const fishingSuccess = roll < successRate;

            // æ£€æŸ¥ç¿»èˆ¹é£é™©
            const capsizeInfo = checkCapsizeRisk(environmentId, gameState.boat, fish, successRate);
            if (capsizeInfo.risk && !fishingSuccess && capsizeInfo.shouldCapsize) {
                handleCapsize();
                return;
            }

            // æ¶ˆè€—é±¼é¥µ
            consumeBait(baitId);

            // æ¶ˆè€—æ¶ˆè€—å“
            if (useConsumable) {
                gameState.consumables.lucky_charm = (gameState.consumables.lucky_charm || 0) - 1;
            }

            if (fishingSuccess) {
                handleFishingSuccess(fish);
            } else {
                showMessage('é’“é±¼å¤±è´¥ï¼Œæ¶ˆè€—äº†1ä¸ªé±¼é¥µ', 'error');
                saveGameState();
                updateUI();
            }
        }

        function validateBait(baitId, fish) {
            if (fish.requiredBaitType === 'live_fish') {
                if (fish.requiredSpecificBait) {
                    if (!fish.requiredSpecificBait.includes(baitId)) {
                        return { valid: false, error: `æ­¤é±¼éœ€è¦ç‰¹å®šçš„æ´»é±¼é±¼é¥µ: ${fish.requiredSpecificBait.map(id => FISH_CONFIG[id].name).join('æˆ–')}` };
                    }
                }
                if (!gameState.liveFishInventory[baitId] || gameState.liveFishInventory[baitId] <= 0) {
                    return { valid: false, error: 'æ²¡æœ‰å¯ç”¨çš„æ´»é±¼é±¼é¥µ' };
                }
                return { valid: true };
            }

            if (baitId === 'plant') {
                if (fish.type !== 'herbivore') {
                    return { valid: false, error: 'æ¤ç‰©æ€§é¥µæ–™åªèƒ½é’“æ¤é£Ÿæ€§é±¼' };
                }
                if (!gameState.baitInventory.plant || gameState.baitInventory.plant <= 0) {
                    return { valid: false, error: 'æ²¡æœ‰æ¤ç‰©æ€§é¥µæ–™' };
                }
                return { valid: true };
            }

            if (baitId === 'dead_fish') {
                if (!gameState.baitInventory.dead_fish || gameState.baitInventory.dead_fish <= 0) {
                    return { valid: false, error: 'æ²¡æœ‰é±¼å—' };
                }
                return { valid: true };
            }

            return { valid: false, error: 'æ— æ•ˆçš„é±¼é¥µ' };
        }

        function consumeBait(baitId) {
            if (baitId === 'plant') {
                gameState.baitInventory.plant = Math.max(0, gameState.baitInventory.plant - 1);
            } else if (baitId === 'dead_fish') {
                gameState.baitInventory.dead_fish = Math.max(0, gameState.baitInventory.dead_fish - 1);
            } else {
                gameState.liveFishInventory[baitId] = Math.max(0, (gameState.liveFishInventory[baitId] || 0) - 1);
            }
        }

        function handleFishingSuccess(fish) {
            const weight = fish.weightRange.min + Math.random() * (fish.weightRange.max - fish.weightRange.min);
            const price = Math.floor(fish.basePrice * (1 + weight / 10));

            // æ›´æ–°å·²é’“é±¼è®°å½•
            const fishRecord = gameState.caughtFish[fish.id] || { count: 0, firstCaught: Date.now(), maxWeight: 0 };
            gameState.caughtFish[fish.id] = {
                count: fishRecord.count + 1,
                firstCaught: fishRecord.firstCaught,
                maxWeight: Math.max(fishRecord.maxWeight, weight)
            };

            // æ·»åŠ åˆ°æ´»é±¼åº“å­˜
            if (fish.canBeBait) {
                gameState.liveFishInventory[fish.id] = (gameState.liveFishInventory[fish.id] || 0) + 1;
            }

            // æ›´æ–°æˆå°±
            if (fish.id === 'giant_squid' && !gameState.achievements.includes('deep_sea_conqueror')) {
                gameState.achievements.push('deep_sea_conqueror');
                showMessage('ğŸ‰ è§£é”æˆå°±ï¼šæ·±æµ·å¾æœè€…ï¼', 'success');
            }
            if (fish.id === 'sperm_whale' && !gameState.achievements.includes('deep_sea_hunter')) {
                gameState.achievements.push('deep_sea_hunter');
                showMessage('ğŸ‰ è§£é”æˆå°±ï¼šæ·±æµ·çŒäººï¼', 'success');
            }
            if (fish.id === 'cthulhu' && !gameState.achievements.includes('forbidden_touch')) {
                gameState.achievements.push('forbidden_touch');
                showMessage('ğŸ‰ è§£é”æˆå°±ï¼šç¦å¿Œä¹‹è§¦ï¼', 'success');
            }

            // æ›´æ–°æ·±æµ·é˜¶æ®µ
            if (fish.id === 'giant_squid' && gameState.deepSeaStage !== 'completed' && gameState.deepSeaStage !== 'ultimate') {
                gameState.deepSeaStage = 'completed';
                showMessage('ğŸ‰ æ·±æµ·æ¢ç´¢å®Œæˆï¼é’“åˆ°å¤§ç‹ä¹Œè´¼ï¼', 'success');
            }
            if (fish.id === 'cthulhu') {
                gameState.deepSeaStage = 'ultimate';
            }

            showMessage(`ğŸ£ æˆåŠŸé’“åˆ° ${fish.name}ï¼é‡é‡: ${weight.toFixed(2)}kgï¼Œä»·å€¼: ${price}å…ƒ`, 'success');
            saveGameState();
            updateUI();
        }

        function handleCapsize() {
            gameState.baitInventory = { plant: 0, dead_fish: 0 };
            gameState.liveFishInventory = {};
            gameState.deathCount = (gameState.deathCount || 0) + 1;
            showMessage('ğŸ’¥ ç¿»èˆ¹äº†ï¼æ‰€æœ‰é±¼é¥µå’Œé±¼éƒ½ä¸¢å¤±äº†ã€‚è¿”å›å²¸è¾¹ã€‚', 'error');
            saveGameState();
            updateUI();
        }

        function handleDeepSeaFailure() {
            gameState.gameOver = true;
            gameState.deathCount = (gameState.deathCount || 0) + 1;
            showMessage('ğŸ’€ æ·±æµ·é’“é±¼å¤±è´¥ã€‚æ¸¸æˆç»“æŸã€‚', 'error');
            saveGameState();
            showSettlement();
        }

        // ========== å•†åº—åŠŸèƒ½ ==========
        function purchaseBoat(boatId) {
            const boat = BOAT_CONFIG[boatId];
            if (!boat) return;

            const boatOrder = ['none', 'small', 'medium', 'large'];
            const currentIndex = boatOrder.indexOf(gameState.boat);
            const newIndex = boatOrder.indexOf(boatId);

            if (newIndex <= currentIndex) {
                showMessage('å·²ç»æ‹¥æœ‰æ­¤èˆ¹åªæˆ–æ›´å¥½çš„èˆ¹åª', 'error');
                return;
            }

            if (gameState.money < boat.price) {
                showMessage('èµ„é‡‘ä¸è¶³', 'error');
                return;
            }

            gameState.money -= boat.price;
            gameState.boat = boatId;
            showMessage(`âœ… è´­ä¹°äº† ${boat.name}`, 'success');
            saveGameState();
            updateUI();
        }

        function purchaseBait(baitId, quantity = 1) {
            const bait = BAIT_CONFIG[baitId];
            if (!bait) return;

            const totalCost = bait.price * quantity;
            if (gameState.money < totalCost) {
                showMessage('èµ„é‡‘ä¸è¶³', 'error');
                return;
            }

            gameState.money -= totalCost;
            gameState.baitInventory[baitId] = (gameState.baitInventory[baitId] || 0) + quantity;
            showMessage(`âœ… è´­ä¹°äº† ${quantity} ä¸ª ${bait.name}`, 'success');
            saveGameState();
            updateUI();
        }

        function purchaseConsumable(consumableId, quantity = 1) {
            const consumable = CONSUMABLE_CONFIG[consumableId];
            if (!consumable) return;

            const totalCost = consumable.price * quantity;
            if (gameState.money < totalCost) {
                showMessage('èµ„é‡‘ä¸è¶³', 'error');
                return;
            }

            gameState.money -= totalCost;
            gameState.consumables[consumableId] = (gameState.consumables[consumableId] || 0) + quantity;
            showMessage(`âœ… è´­ä¹°äº† ${quantity} ä¸ª ${consumable.name}`, 'success');
            saveGameState();
            updateUI();
        }

        // ========== UI æ›´æ–° ==========
        function updateUI() {
            // æ›´æ–°åŸºæœ¬ä¿¡æ¯
            document.getElementById('money').textContent = gameState.money;
            document.getElementById('boat').textContent = BOAT_CONFIG[gameState.boat].name;
            document.getElementById('caughtCount').textContent = Object.keys(gameState.caughtFish).length;
            document.getElementById('achievementCount').textContent = gameState.achievements.length;

            // æ›´æ–°ç¯å¢ƒé€‰æ‹©
            updateEnvironmentSelect();

            // æ›´æ–°é±¼ç±»é€‰æ‹©
            updateFishSelect();

            // æ›´æ–°é±¼é¥µé€‰æ‹©
            updateBaitSelect();

            // æ›´æ–°å•†åº—
            updateShop();

            // æ›´æ–°åº“å­˜
            updateInventory();

            // æ›´æ–°æˆå°±
            updateAchievements();
        }

        function updateEnvironmentSelect() {
            const select = document.getElementById('environmentSelect');
            select.innerHTML = '';
            Object.values(ENVIRONMENT_CONFIG).forEach(env => {
                if (canBoatAccessEnvironment(gameState.boat, env.id)) {
                    const option = document.createElement('option');
                    option.value = env.id;
                    option.textContent = env.name;
                    select.appendChild(option);
                }
            });
            select.dispatchEvent(new Event('change'));
        }

        function updateFishSelect() {
            const select = document.getElementById('fishSelect');
            const environmentId = document.getElementById('environmentSelect').value;
            const fishList = getFishByEnvironment(environmentId);
            
            select.innerHTML = '<option value="">-- é€‰æ‹©é±¼ç±» --</option>';
            fishList.forEach(fish => {
                const option = document.createElement('option');
                option.value = fish.id;
                option.textContent = `${fish.name} (éš¾åº¦${fish.difficulty})`;
                select.appendChild(option);
            });
        }

        function updateBaitSelect() {
            const select = document.getElementById('baitSelect');
            const fishId = document.getElementById('fishSelect').value;
            const fish = FISH_CONFIG[fishId];
            
            select.innerHTML = '<option value="">-- é€‰æ‹©é±¼é¥µ --</option>';

            if (fish) {
                if (fish.requiredBaitType === 'plant') {
                    if (gameState.baitInventory.plant > 0) {
                        const option = document.createElement('option');
                        option.value = 'plant';
                        option.textContent = `æ¤ç‰©æ€§é¥µæ–™ (${gameState.baitInventory.plant}ä¸ª)`;
                        select.appendChild(option);
                    }
                } else if (fish.requiredBaitType === 'live_fish') {
                    // æ˜¾ç¤ºå¯ç”¨çš„æ´»é±¼
                    Object.keys(gameState.liveFishInventory).forEach(fishId => {
                        const count = gameState.liveFishInventory[fishId];
                        if (count > 0) {
                            if (!fish.requiredSpecificBait || fish.requiredSpecificBait.includes(fishId)) {
                                const option = document.createElement('option');
                                option.value = fishId;
                                option.textContent = `${FISH_CONFIG[fishId].name} (${count}ä¸ª)`;
                                select.appendChild(option);
                            }
                        }
                    });
                    // ä¹Ÿå¯ä»¥ä½¿ç”¨æ­»é±¼
                    if (gameState.baitInventory.dead_fish > 0) {
                        const option = document.createElement('option');
                        option.value = 'dead_fish';
                        option.textContent = `é±¼å—ï¼ˆæ­»é±¼ï¼‰ (${gameState.baitInventory.dead_fish}ä¸ª)`;
                        select.appendChild(option);
                    }
                }
            }
        }

        function updateShop() {
            // èˆ¹åªå•†åº—
            const boatShop = document.getElementById('boatShop');
            boatShop.innerHTML = '';
            Object.values(BOAT_CONFIG).forEach(boat => {
                if (boat.id === 'none') return;
                const boatOrder = ['none', 'small', 'medium', 'large'];
                const currentIndex = boatOrder.indexOf(gameState.boat);
                const boatIndex = boatOrder.indexOf(boat.id);
                const canBuy = boatIndex > currentIndex && gameState.money >= boat.price;
                
                const div = document.createElement('div');
                div.className = 'boat-item';
                div.innerHTML = `
                    <h3>${boat.name}</h3>
                    <p>ä»·æ ¼: ${boat.price}å…ƒ</p>
                    <button class="button" ${!canBuy ? 'disabled' : ''} onclick="purchaseBoat('${boat.id}')">è´­ä¹°</button>
                `;
                boatShop.appendChild(div);
            });

            // é±¼é¥µå•†åº—
            const baitShop = document.getElementById('baitShop');
            baitShop.innerHTML = '';
            Object.values(BAIT_CONFIG).forEach(bait => {
                const div = document.createElement('div');
                div.className = 'bait-item';
                div.innerHTML = `
                    <h3>${bait.name}</h3>
                    <p>ä»·æ ¼: ${bait.price}å…ƒ/ä¸ª</p>
                    <button class="button" onclick="purchaseBait('${bait.id}', 1)">ä¹°1ä¸ª</button>
                    <button class="button" onclick="purchaseBait('${bait.id}', 10)">ä¹°10ä¸ª</button>
                `;
                baitShop.appendChild(div);
            });

            // æ¶ˆè€—å“å•†åº—
            const consumableShop = document.getElementById('consumableShop');
            consumableShop.innerHTML = '';
            Object.values(CONSUMABLE_CONFIG).forEach(consumable => {
                const div = document.createElement('div');
                div.className = 'bait-item';
                div.innerHTML = `
                    <h3>${consumable.name}</h3>
                    <p>ä»·æ ¼: ${consumable.price}å…ƒ/ä¸ª</p>
                    <button class="button" onclick="purchaseConsumable('${consumable.id}', 1)">ä¹°1ä¸ª</button>
                `;
                consumableShop.appendChild(div);
            });
        }

        function updateInventory() {
            // é±¼é¥µåº“å­˜
            const baitInventory = document.getElementById('baitInventory');
            baitInventory.innerHTML = '';
            Object.keys(BAIT_CONFIG).forEach(baitId => {
                const count = gameState.baitInventory[baitId] || 0;
                if (count > 0) {
                    const div = document.createElement('div');
                    div.className = 'bait-item';
                    div.innerHTML = `<strong>${BAIT_CONFIG[baitId].name}:</strong> ${count}ä¸ª`;
                    baitInventory.appendChild(div);
                }
            });

            // æ´»é±¼åº“å­˜
            const liveFishInventory = document.getElementById('liveFishInventory');
            liveFishInventory.innerHTML = '';
            Object.keys(gameState.liveFishInventory).forEach(fishId => {
                const count = gameState.liveFishInventory[fishId];
                if (count > 0) {
                    const div = document.createElement('div');
                    div.className = 'fish-item';
                    div.innerHTML = `<strong>${FISH_CONFIG[fishId].name}:</strong> ${count}ä¸ª (å¯ç”¨ä½œé±¼é¥µ)`;
                    liveFishInventory.appendChild(div);
                }
            });
        }

        function updateAchievements() {
            const area = document.getElementById('achievementsArea');
            area.innerHTML = '';
            Object.values(ACHIEVEMENT_CONFIG).forEach(achievement => {
                const hasAchievement = gameState.achievements.includes(achievement.id);
                const div = document.createElement('div');
                div.className = `achievement ${hasAchievement ? '' : 'locked'}`;
                div.textContent = hasAchievement ? achievement.name : `${achievement.name} (æœªè§£é”)`;
                area.appendChild(div);
            });
        }

        function showMessage(message, type = 'info') {
            const area = document.getElementById('messageArea');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = message;
            area.appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        function showSettlement() {
            const settlement = getSettlement();
            const content = document.getElementById('settlementContent');
            content.innerHTML = `
                <div class="settlement-item">
                    <strong>ç§°å·:</strong> ${settlement.achievements.map(a => a.name).join(', ')}
                </div>
                <div class="settlement-item">
                    <strong>é’“åˆ°é±¼ç§:</strong> ${settlement.fishSpeciesCaught} / ${settlement.totalFishSpecies}
                </div>
                <div class="settlement-item">
                    <strong>æœ€ç¨€æœ‰é±¼:</strong> ${settlement.rarestFish ? settlement.rarestFish.name : 'æ— '}
                </div>
                <div class="settlement-item">
                    <strong>æœ€å¤§å•é±¼ä»·å€¼:</strong> ${settlement.maxValueFish ? settlement.maxValueFish.value + 'å…ƒ (' + settlement.maxValueFish.name + ')' : 'æ— '}
                </div>
                <div class="settlement-item">
                    <strong>æ€»æ¸¸æˆæ—¶é—´:</strong> ${Math.floor(settlement.totalGameTime / 60)}åˆ†é’Ÿ
                </div>
                <div class="settlement-item">
                    <strong>æ­»äº¡æ¬¡æ•°:</strong> ${settlement.deathCount}
                </div>
            `;
            document.getElementById('settlementModal').classList.add('active');
        }

        function closeSettlement() {
            document.getElementById('settlementModal').classList.remove('active');
        }

        function getSettlement() {
            const caughtCount = Object.keys(gameState.caughtFish).length;
            const allFishIds = Object.keys(FISH_CONFIG);
            
            let rarestFish = null;
            let maxDifficulty = 0;
            Object.keys(gameState.caughtFish).forEach(fishId => {
                const fish = FISH_CONFIG[fishId];
                if (fish && fish.difficulty > maxDifficulty) {
                    maxDifficulty = fish.difficulty;
                    rarestFish = { id: fish.id, name: fish.name, difficulty: fish.difficulty };
                }
            });

            let maxValue = 0;
            let maxValueFish = null;
            Object.keys(gameState.caughtFish).forEach(fishId => {
                const fish = FISH_CONFIG[fishId];
                if (fish) {
                    const record = gameState.caughtFish[fishId];
                    const estimatedValue = fish.basePrice * (1 + record.maxWeight / 10);
                    if (estimatedValue > maxValue) {
                        maxValue = estimatedValue;
                        maxValueFish = { id: fish.id, name: fish.name, value: Math.floor(estimatedValue) };
                    }
                }
            });

            const achievements = gameState.achievements.map(id => ({
                id,
                name: ACHIEVEMENT_CONFIG[id]?.name || id
            }));

            const timeDiff = Math.floor((Date.now() - gameState.lastUpdateTime) / 1000);
            const totalGameTime = gameState.gameTime + timeDiff;

            return {
                achievements,
                fishSpeciesCaught: caughtCount,
                totalFishSpecies: allFishIds.length,
                rarestFish,
                maxValueFish,
                totalGameTime,
                deathCount: gameState.deathCount || 0
            };
        }

        function resetGame() {
            if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹æ¸¸æˆå—ï¼Ÿæ‰€æœ‰è¿›åº¦å°†ä¸¢å¤±ï¼')) {
                resetGameState();
                closeSettlement();
                showMessage('æ¸¸æˆå·²é‡ç½®', 'success');
            }
        }

        function endGame() {
            gameState.gameOver = true;
            saveGameState();
            showSettlement();
        }

        // ========== äº‹ä»¶ç›‘å¬ ==========
        document.getElementById('environmentSelect').addEventListener('change', updateFishSelect);
        document.getElementById('fishSelect').addEventListener('change', updateBaitSelect);

        // ========== åˆå§‹åŒ– ==========
        loadGameState();
        updateUI();
    </script>
</body>
</html>

